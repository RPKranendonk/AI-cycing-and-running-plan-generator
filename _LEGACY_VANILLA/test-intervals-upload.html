<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intervals.icu API Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .week-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workout-day {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #4a9eff;
        }

        .workout-day.rest {
            border-left-color: #22c55e;
        }

        .workout-day.long-run {
            border-left-color: #f97316;
        }

        .workout-day.intervals {
            border-left-color: #ef4444;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
            color: #fff;
            font-size: 1.1rem;
        }

        .workout-type {
            font-size: 0.85rem;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .workout-description {
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.5;
            white-space: pre-line;
        }

        .preview-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .preview-title {
            font-size: 0.85rem;
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .preview-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .preview-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .preview-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-value {
            color: #e0e0e0;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            white-space: pre-line;
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .push-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .push-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .push-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 87, 108, 0.4);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .config-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 0.95rem;
        }

        input::placeholder {
            color: #64748b;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Intervals.icu API Upload Test</h1>

        <div class="config-section">
            <h3 style="margin-bottom: 15px; color: #fff;">Configuration</h3>
            <div class="config-row">
                <div>
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" placeholder="Enter your Intervals.icu API key">
                </div>
                <div>
                    <label for="athleteId">Athlete ID</label>
                    <input type="text" id="athleteId" placeholder="Enter your Athlete ID">
                </div>
            </div>
        </div>

        <div class="week-container" id="week-container">
            <!-- Workouts will be inserted here -->
        </div>

        <div class="button-container">
            <button class="push-btn" onclick="pushToIntervals()">üì§ Push to Intervals</button>
            <button class="clear-btn" onclick="clearWeek()">üóëÔ∏è Clear Week</button>
        </div>

        <div class="config-section" style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px; color: #fff;">üì§ Payload Preview (What is being sent)</h3>
            <pre id="payload-preview"
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow-x: auto; color: #a78bfa; font-family: 'Courier New', monospace; font-size: 0.85rem; white-space: pre-wrap;"></pre>
        </div>
        <div class="config-section" style="margin-top: 30px; border-color: #f59e0b;">
            <h3 style="margin-bottom: 15px; color: #fcd34d;">üß† Smart Block Planner (Logic-Based)</h3>
            <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                Fetches your last 28 days of history from Intervals.icu and calculates the next week's volume and long
                run
                targets based on a 10% progression rule.
            </p>
            <button class="push-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"
                onclick="calculateSmartBlock()">üìä Fetch History & Plan Next Block</button>

            <div id="smart-plan-result" style="margin-top: 20px; display: none;">
                <!-- Compact History List -->
                <div class="preview-box" style="margin-bottom: 15px;">
                    <div class="preview-label">Recent Training History</div>
                    <div id="weekly-breakdown" style="font-size: 0.9rem; line-height: 1.6; color: #cbd5e1;">
                        Loading...</div>
                </div>

                <!-- Summary Sentence -->
                <div
                    style="margin-bottom: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.9rem; color: #e0e0e0; line-height: 1.5;">
                    <span id="history-summary-text">Calculating summary...</span>
                </div>

                <!-- Recommendation Section -->
                <div
                    style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 15px;">
                    <h4 id="recommendation-title" style="color: #4ade80; margin-bottom: 10px; font-size: 1rem;">üöÄ
                        Proposed Next Block Start</h4>
                    <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                        Based on your previous weeks, we recommend the following starting targets. You can adjust them
                        below:
                    </p>

                    <!-- Rest Week Option (Hidden by default) -->
                    <div id="rest-week-suggestion"
                        style="display: none; margin-bottom: 15px; background: rgba(250, 204, 21, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(250, 204, 21, 0.3);">
                        <!-- Content injected by JS -->
                    </div>

                    <!-- Inputs -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="preview-label" style="margin-bottom: 5px; display:block;">Starting Volume
                                (km)</label>
                            <input type="number" id="target-volume"
                                style="font-size: 1.1rem; font-weight: bold; color: #fff; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); padding: 8px; width: 100%; border-radius: 4px;"
                                placeholder="0.0">
                        </div>
                        <div>
                            <label class="preview-label" style="margin-bottom: 5px; display:block;">Longest Run
                                (km)</label>
                            <input type="number" id="target-long-run"
                                style="font-size: 1.1rem; font-weight: bold; color: #fff; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); padding: 8px; width: 100%; border-radius: 4px;"
                                placeholder="0.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-section" style="margin-top: 30px; border-color: #ec4899;">
            <h3 style="margin-bottom: 15px; color: #f472b6;">üéØ Weekly Targets Test</h3>
            <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                Push weekly targets for Run (Distance) and Cycling (Load/TSS).
            </p>

            <div class="config-row">
                <div>
                    <label for="target-start-date">Target Week Start (Monday)</label>
                    <input type="date" id="target-start-date">
                </div>
            </div>
            <!-- Week 1 Inputs -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #a78bfa; margin-bottom: 10px;">Week 1</h4>
                <div class="config-row" style="margin-bottom: 0;">
                    <div>
                        <label for="run-target-dist">Run Distance (km)</label>
                        <input type="number" id="run-target-dist" placeholder="e.g. 50">
                    </div>
                    <div>
                        <label for="cycle-target-load">Cycling Load (TSS)</label>
                        <input type="number" id="cycle-target-load" placeholder="e.g. 500">
                    </div>
                </div>
            </div>

            <!-- Week 2 Inputs -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                <h4 id="week2-header" style="color: #f472b6; margin-bottom: 10px;">Week 2 (Starts ...)</h4>
                <div class="config-row" style="margin-bottom: 0;">
                    <div>
                        <label for="run-target-dist-w2">Run Distance (km)</label>
                        <input type="number" id="run-target-dist-w2" placeholder="e.g. 55">
                    </div>
                    <div>
                        <label for="cycle-target-load-w2">Cycling Load (TSS)</label>
                        <input type="number" id="cycle-target-load-w2" placeholder="e.g. 520">
                    </div>
                </div>
            </div>

            <div class="button-container" style="margin-top: 20px;">
                <button class="push-btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);"
                    onclick="pushTargets()">üöÄ Push Targets (Week 1 & 2)</button>
            </div>
        </div>

        <!-- ===== ZONE SYNC SECTION ===== -->
        <div class="config-section" style="margin-top: 30px; border-color: #22c55e;">
            <h3 style="margin-bottom: 15px; color: #4ade80;">‚ö° Running Pace Zone Sync</h3>
            <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                Calculate zones from your threshold pace, compare with Intervals.icu, and optionally sync them.
            </p>

            <!-- Step 1: Threshold Estimator -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #a78bfa; margin-bottom: 10px;">Step 1: Enter Threshold Pace</h4>
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 15px;">
                    Your lactate threshold (LT) pace - the pace you can sustain for ~60 minutes.
                </p>
                <div class="config-row">
                    <div>
                        <label for="lt-pace-min">LT Pace (min:sec per km)</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="lt-pace-min" placeholder="4" min="2" max="10" style="width: 60px;"
                                value="4">
                            <span style="color: #fff;">:</span>
                            <input type="number" id="lt-pace-sec" placeholder="30" min="0" max="59" style="width: 60px;"
                                value="30">
                            <span style="color: #94a3b8; margin-left: 10px;">/km</span>
                        </div>
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="push-btn"
                            style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 10px 20px;"
                            onclick="calculateZonesFromThreshold()">üìä Calculate Zones</button>
                    </div>
                </div>

                <!-- Calculated Zones Display -->
                <div id="calculated-zones-container" style="display: none; margin-top: 20px;">
                    <h4 style="color: #4ade80; margin-bottom: 10px;">Calculated Zones (Friel 7-Zone System)</h4>
                    <div id="calculated-zones-table"></div>
                </div>
            </div>

            <!-- Step 2: Fetch from Intervals.icu -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #f472b6; margin-bottom: 10px;">Step 2: Fetch from Intervals.icu</h4>
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 15px;">
                    Compare your calculated zones with what's configured in Intervals.icu.
                    <br><em style="color: #fbbf24; font-size: 0.8rem;">
                        Note: Intervals.icu may display pace 1s faster than the API returns.
                    </em>
                </p>
                <button class="push-btn"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 10px 20px;"
                    onclick="fetchIntervalsZones()">üîÑ Fetch Intervals.icu Zones</button>

                <!-- Fetched Zones Display -->
                <div id="intervals-zones-container" style="display: none; margin-top: 20px;">
                    <h4 style="color: #60a5fa; margin-bottom: 10px;">Intervals.icu Zones</h4>
                    <div id="intervals-zones-table"></div>
                </div>
            </div>

            <!-- Step 3: Comparison & Sync -->
            <div id="zone-comparison-container"
                style="display: none; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #fbbf24; margin-bottom: 10px;">Step 3: Zone Comparison</h4>
                <div id="zone-comparison-table"></div>

                <div id="sync-options" style="margin-top: 20px;">
                    <!-- Buttons will be added dynamically -->
                </div>
            </div>

            <!-- Background Sync Check Section -->
            <div
                style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(139, 92, 246, 0.3);">
                <h4 style="color: #a78bfa; margin-bottom: 10px;">üîÑ Automatic Zone Sync Check</h4>
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 15px;">
                    Run a full sync check to compare your calculated zones with Intervals.icu.
                    If no zones are set, they'll be pushed automatically. If zones differ, you'll choose which to use.
                </p>
                <button class="push-btn"
                    style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 12px 24px;"
                    onclick="runZoneSyncCheck()">üîÑ Run Full Sync Check</button>

                <div id="sync-check-status" style="margin-top: 15px; display: none;"></div>
            </div>

            <!-- Sync Choice Dialog (initially hidden) -->
            <div id="sync-choice-dialog"
                style="display: none; background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid rgba(251, 191, 36, 0.5);">
                <h4 style="color: #fbbf24; margin-bottom: 10px;">‚ö†Ô∏è Zone Mismatch Detected</h4>
                <div id="sync-choice-content"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Pre-populated workout data for the week starting Dec 1, 2025
        const workouts = [
            {
                date: "2025-12-08",
                day: "Monday",
                type: "Recovery",
                className: "rest",
                description_ui: "Easy recovery run - 40 min",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 25m 65-75% Pace

Cooldown
- 5m 60% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 1500, intensity: "65-75% Pace" },
                    { type: "Cooldown", duration: 300, intensity: "60% Pace" }
                ]
            },
            {
                date: "2025-12-09",
                day: "Tuesday",
                type: "Endurance Run",
                className: "intervals",
                description_ui: "Steady endurance run - 70 min",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 50m 75-85% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 3000, intensity: "75-85% Pace" },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            },
            {
                date: "2025-12-10",
                day: "Wednesday",
                type: "5km + Strides",
                className: "intervals",
                description_ui: "5km run + 6x100m strides",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 5.00km 80-85% Pace

Strides
6x
- Press Lap 0.10km 95-100% Pace
- Press Lap 1m 50-65% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", distance: 5000, intensity: "80-85% Pace" },
                    { type: "Run", distance: 100, intensity: "95-100% Pace", reps: 6, recovery_duration: 60, recovery_intensity: "50% Pace", recovery_press_lap: true },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            },
            {
                date: "2025-12-11",
                day: "Friday",
                type: "VO2 Max Intervals",
                className: "intervals",
                description_ui: "4x3min VO2 Max intervals",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
4x
- 3m 100-105% Pace
- 3m 50-65% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 180, intensity: "100-105% Pace", reps: 4, recovery_duration: 180, recovery_intensity: "60% Pace" },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            },
            {
                date: "2025-12-12",
                day: "Sunday",
                type: "Long Run",
                className: "long-run",
                description_ui: "Long run - 110 min steady",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 90m 70-80% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 5400, intensity: "70-80% Pace" },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            }
        ];

        // Render workouts on page load
        function renderWorkouts() {
            const container = document.getElementById('week-container');
            let html = '';

            workouts.forEach(workout => {
                const formattedDesc = formatStepsForIntervals(workout.steps);
                html += `
                    <div class="workout-card">
                        <div class="workout-day ${workout.className}">
                            <div class="day-header">
                                <div class="day-name">${workout.day} (${workout.date})</div>
                                <div class="workout-type">${workout.type}</div>
                            </div>
                            <div class="workout-description">${workout.description}</div>
                        </div>
                        <div class="preview-section">
                            <div class="preview-title">üìã How this will appear in Intervals.icu</div>
                            <div class="preview-content">
                                <div class="preview-box">
                                    <div class="preview-label">Workout Title</div>
                                    <div class="preview-value">${workout.type}</div>
                                </div>
                                <div class="preview-box">
                                    <div class="preview-label">Weekly Overview Description</div>
                                    <div class="preview-value">${workout.description_ui}</div>
                                </div>
                            </div>
                            <div class="preview-box" style="margin-top: 10px;">
                                <div class="preview-label">Full Workout Description (API Format)</div>
                                <div class="preview-value">${formattedDesc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Format steps for Intervals.icu API
        function formatStepsForIntervals(steps) {
            if (!steps || !Array.isArray(steps)) return "";

            let text = "";
            steps.forEach(step => {
                let line = "";

                if (step.type === "Warmup") line += "Warmup\n";
                if (step.type === "Cooldown") line += "Cooldown\n";
                if (step.type === "Rest") line += "Rest\n";

                let dur = "";
                if (step.duration) {
                    const mins = Math.floor(step.duration / 60);
                    const secs = step.duration % 60;
                    if (mins > 0) dur += `${mins}m`;
                    if (secs > 0) dur += `${secs}s`;
                } else if (step.distance) {
                    // Always use km to avoid Intervals.icu interpreting meters as minutes
                    dur += `${(step.distance / 1000).toFixed(2)}km`;
                }

                let intensity = step.intensity || "";
                let pressLap = step.press_lap ? "Press Lap " : "";

                if (step.reps) {
                    line += `${step.reps}x\n`;
                    line += `- ${pressLap}${dur} ${intensity}\n`;

                    if (step.recovery_duration || step.recovery_distance) {
                        let recDur = "";
                        if (step.recovery_duration) {
                            const rMins = Math.floor(step.recovery_duration / 60);
                            const rSecs = step.recovery_duration % 60;
                            if (rMins > 0) recDur += `${rMins}m`;
                            if (rSecs > 0) recDur += `${rSecs}s`;
                        } else if (step.recovery_distance) {
                            // Always use km to avoid Intervals.icu interpreting meters as minutes
                            recDur += `${(step.recovery_distance / 1000).toFixed(2)}km`;
                        }
                        let recInt = step.recovery_intensity || "50-65% Pace";
                        let recPressLap = step.recovery_press_lap ? "Press Lap " : "";
                        line += `- ${recPressLap}${recDur} ${recInt}\n`;
                    }
                } else {
                    line += `- ${pressLap}${dur} ${intensity}\n`;
                }

                text += line + "\n";
            });
            return text.trim();
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Push workouts to Intervals.icu
        async function pushToIntervals() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID');
                return;
            }

            const pushBtn = document.querySelector('.push-btn');
            pushBtn.disabled = true;
            pushBtn.textContent = '‚è≥ Pushing...';

            try {
                // First, delete existing workouts for this week
                await deleteWorkoutsForWeek(apiKey, athleteId);

                // Prepare events
                const events = generateEvents();

                // Bulk create
                const response = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/bulk?upsert=true`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(`API_KEY:${apiKey}`),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(events)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                showToast(`‚úÖ Successfully pushed ${events.length} workouts!`);
            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                pushBtn.disabled = false;
                pushBtn.textContent = 'üì§ Push to Intervals';
            }
        }

        function generateEvents() {
            return workouts.map(workout => ({
                category: "WORKOUT",
                start_date_local: `${workout.date}T00:00:00`,
                type: "Run",
                name: workout.type,
                description: formatStepsForIntervals(workout.steps),
                external_id: `test_upload_${workout.date}`
            }));
        }

        function renderPayload() {
            const events = generateEvents();
            document.getElementById('payload-preview').textContent = JSON.stringify(events, null, 2);
        }

        // Clear week from Intervals.icu
        async function clearWeek() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID');
                return;
            }

            if (!confirm('Delete all test workouts from Intervals.icu?')) {
                return;
            }

            const clearBtn = document.querySelector('.clear-btn');
            clearBtn.disabled = true;
            clearBtn.textContent = '‚è≥ Clearing...';

            try {
                await deleteWorkoutsForWeek(apiKey, athleteId);
                showToast('‚úÖ Workouts cleared successfully!');
            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                clearBtn.disabled = false;
                clearBtn.textContent = 'üóëÔ∏è Clear Week';
            }
        }

        // Delete workouts for the test week
        async function deleteWorkoutsForWeek(apiKey, athleteId) {
            const auth = btoa(`API_KEY:${apiKey}`);

            // Fetch events for the week
            const startDate = '2025-12-08';
            const endDate = '2025-12-14';

            const response = await fetch(
                `https://intervals.icu/api/v1/athlete/${athleteId}/events?oldest=${startDate}&newest=${endDate}`,
                {
                    headers: { 'Authorization': `Basic ${auth}` }
                }
            );

            if (!response.ok) {
                throw new Error(`Failed to fetch events: ${response.status}`);
            }

            const events = await response.json();

            // Filter for our test workouts
            const testWorkouts = events.filter(e =>
                e.external_id && e.external_id.startsWith('test_upload_')
            );

            // Delete each workout
            for (const event of testWorkouts) {
                await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/${event.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Basic ${auth}` }
                });
            }
        }

        // Initialize
        renderWorkouts();
        renderPayload();

        // Load saved config from localStorage if available
        const savedApiKey = localStorage.getItem('intervals_api_key');
        const savedAthleteId = localStorage.getItem('intervals_athlete_id');
        if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
        if (savedAthleteId) document.getElementById('athleteId').value = savedAthleteId;

        // Save config to localStorage when changed
        document.getElementById('apiKey').addEventListener('change', (e) => {
            localStorage.setItem('intervals_api_key', e.target.value);
        });
        document.getElementById('athleteId').addEventListener('change', (e) => {
            localStorage.setItem('intervals_athlete_id', e.target.value);
        });

        async function calculateSmartBlock() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID');
                return;
            }

            const resultDiv = document.getElementById('smart-plan-result');
            resultDiv.style.display = 'block';
            document.getElementById('weekly-breakdown').textContent = 'Fetching and analyzing...';

            try {
                // 1. Fetch Activities (Last 35 days to ensure we have 4 full weeks + baseline)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 35);

                const sStr = startDate.toISOString().split('T')[0];
                const eStr = endDate.toISOString().split('T')[0];
                const auth = btoa(`API_KEY:${apiKey}`);

                console.log('Fetching activities from', sStr, 'to', eStr);
                const url = `https://intervals.icu/api/v1/athlete/${athleteId}/activities?oldest=${sStr}&newest=${eStr}`;
                console.log('Request URL:', url);

                const res = await fetch(url, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                console.log('Response status:', res.status, res.statusText);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`Failed to fetch activities: ${res.status} - ${errorText}`);
                }

                const activities = await res.json();
                console.log('Fetched activities:', activities.length, 'total');

                const runActivities = activities.filter(a => a.type === 'Run');
                console.log('Run activities:', runActivities.length);

                if (runActivities.length === 0) {
                    document.getElementById('weekly-breakdown').textContent = 'No running activities found in the last 35 days.';
                    document.getElementById('target-volume').textContent = '-';
                    document.getElementById('target-long-run').textContent = '-';
                    showToast('‚ö†Ô∏è No running data found');
                    return;
                }

                // 2. Group by Week (Monday-Sunday)
                const weeks = {};
                runActivities.forEach(act => {
                    const d = new Date(act.start_date_local);
                    const weekNum = getWeekNumber(d);
                    const year = d.getFullYear();
                    const key = `${year}-W${weekNum}`;

                    if (!weeks[key]) weeks[key] = { vol: 0, longRun: 0, count: 0, weekNum: weekNum, year: year };

                    const km = (act.distance || 0) / 1000;
                    weeks[key].vol += km;
                    weeks[key].count++;
                    if (km > weeks[key].longRun) weeks[key].longRun = km;
                });

                // Sort weeks chronologically
                const sortedWeeks = Object.keys(weeks).sort().map(k => weeks[k]);
                console.log('Weeks found:', sortedWeeks.length, sortedWeeks);

                // We want the last 4 weeks. 
                // If we have more, take the last 4. If less, take what we have.
                const weeksToAnalyze = sortedWeeks.slice(-4);

                // 3. Generate Breakdown & Calculate Increases
                let breakdownHtml = '';
                let totalIncrease = 0;
                let increaseCount = 0;

                // Find Maxes (Last 4 Weeks)
                let maxVol = 0;
                let maxLR = 0;

                weeksToAnalyze.forEach((week, index) => {
                    let increaseStr = '';
                    let pctIncrease = 0;

                    // Compare with previous week
                    const weekIndexInFullList = sortedWeeks.indexOf(week);
                    if (weekIndexInFullList > 0) {
                        const prevWeek = sortedWeeks[weekIndexInFullList - 1];
                        if (prevWeek.vol > 0) {
                            pctIncrease = ((week.vol - prevWeek.vol) / prevWeek.vol) * 100;
                            increaseStr = `(${pctIncrease > 0 ? '+' : ''}${pctIncrease.toFixed(1)}%)`;

                            totalIncrease += pctIncrease;
                            increaseCount++;
                        }
                    }

                    // Update Maxes
                    if (week.vol > maxVol) maxVol = week.vol;
                    if (week.longRun > maxLR) maxLR = week.longRun;

                    // New Format: "Week XX: longest run Xkm and total volume Xkm (+X%)"
                    breakdownHtml += `<div style="margin-bottom: 4px;">Week ${week.weekNum}: Longest Run <strong>${week.longRun.toFixed(1)}km</strong> and Total Volume <strong>${week.vol.toFixed(1)}km</strong> <span style="color: ${pctIncrease > 5 ? '#facc15' : '#94a3b8'}">${increaseStr}</span></div>`;
                });

                // Display weekly breakdown
                document.getElementById('weekly-breakdown').innerHTML = breakdownHtml || "No recent running data found.";

                // 4. Average Increase & Summary Logic
                let avgIncrease = 0;
                if (increaseCount > 0) {
                    avgIncrease = totalIncrease / increaseCount;
                }

                // Summary Sentence: "Your longest run was Xkm and your biggest week was Xkm, on average you increased your volume by X% over the last 4 weeks."
                const summaryText = `Your longest run was <strong>${maxLR.toFixed(1)}km</strong> and your biggest week was <strong>${maxVol.toFixed(1)}km</strong>. On average you increased your volume by <strong>${avgIncrease.toFixed(1)}%</strong> over the last 4 weeks.`;
                document.getElementById('history-summary-text').innerHTML = summaryText;

                // 6. Determine Recommendation (Block Start)
                const proposedVol = maxVol * 1.10;
                let proposedLR = maxLR + 2.0;

                // Caps
                if (proposedLR > 34) proposedLR = 34;
                if (proposedLR > proposedVol * 0.55) proposedLR = proposedVol * 0.55; // 55% cap from logic.js

                // 7. Rest Week Logic
                let needRest = false;
                if (avgIncrease > 5) {
                    needRest = true;
                }

                const restDiv = document.getElementById('rest-week-suggestion');
                const resultHeader = document.getElementById('recommendation-title');

                // Calculate scenarios
                const aggressiveVol = (maxVol * 1.10).toFixed(1);
                const aggressiveLR = Math.min(maxLR + 2.0, 34, maxVol * 1.10 * 0.55).toFixed(1); // Apply caps

                const conservativeVol = (maxVol * 0.90).toFixed(1);
                const conservativeLR = Math.min(maxLR - 2.0, 34, maxVol * 0.90 * 0.55).toFixed(1); // Apply caps

                const lastWeek = weeksToAnalyze[weeksToAnalyze.length - 1] || { vol: 0, longRun: 0 };
                const restVol = (lastWeek.vol * 0.60).toFixed(1);
                const restLR = (lastWeek.longRun * 0.70).toFixed(1);

                if (needRest) {
                    restDiv.style.display = 'block';
                    restDiv.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            ‚ö†Ô∏è <strong>Rest Week Recommended!</strong><br>
                            <span style="font-size: 0.85rem; opacity: 0.9;">
                                Your average volume increase (${avgIncrease.toFixed(1)}%) is high (>5%). 
                                Taking a rest week allows your body to absorb the training, repair muscle damage, and prevent injury. 
                                Adaptation happens during rest, not just work!
                            </span>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                            <strong>Suggested Rest Week:</strong> ${restVol} km (LR: ${restLR} km)
                        </div>
                        <label style="display: flex; align-items: center; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px;">
                            <input type="checkbox" id="use-rest-week" style="width: auto; margin-right: 10px;">
                            <span>Start plan with this Rest Week?</span>
                        </label>
                        <div style="font-size: 0.8rem; margin-top: 5px; color: #cbd5e1;">
                            *If checked, the targets below will be set for the first <strong>build week</strong> after the rest week (Max -10%).
                        </div>
                    `;

                    // Event Listener for Checkbox
                    const checkbox = document.getElementById('use-rest-week');
                    const volInput = document.getElementById('target-volume');
                    const lrInput = document.getElementById('target-long-run');

                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            volInput.value = conservativeVol;
                            lrInput.value = conservativeLR;
                            showToast("üìâ Targets adjusted for post-rest rebuild");
                        } else {
                            volInput.value = aggressiveVol;
                            lrInput.value = aggressiveLR;
                            showToast("üìà Targets reset to aggressive progression");
                        }
                    });

                    // Default to unchecked (Aggressive)
                    volInput.value = aggressiveVol;
                    lrInput.value = aggressiveLR;

                    showToast("üõå Rest Week Recommended!");
                } else {
                    restDiv.style.display = 'none';

                    document.getElementById('target-volume').value = aggressiveVol;
                    document.getElementById('target-long-run').value = aggressiveLR;

                    showToast("‚úÖ Smart Plan Calculated!");
                }

            } catch (e) {
                console.error('Error in calculateSmartBlock:', e);
                showToast(`‚ùå Error: ${e.message}`);
                document.getElementById('weekly-breakdown').textContent = `Error: ${e.message}`;
            }
        }

        // --- Weekly Targets Logic ---

        // Set default date to next Monday and update Week 2 label
        function setDefaultTargetDate() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
            const nextMonday = new Date(today.setDate(diff + 7));
            const dateStr = nextMonday.toISOString().split('T')[0];

            const dateInput = document.getElementById('target-start-date');
            dateInput.value = dateStr;
            updateWeek2Label(dateStr);

            // Add listener
            dateInput.addEventListener('change', (e) => updateWeek2Label(e.target.value));
        }

        function updateWeek2Label(startDateStr) {
            if (!startDateStr) return;
            const d = new Date(startDateStr);
            d.setDate(d.getDate() + 7);
            const w2Str = d.toISOString().split('T')[0];
            document.getElementById('week2-header').textContent = `Week 2 (Starts ${w2Str})`;
        }

        // Call it after DOM load or just here if script is at end of body
        setDefaultTargetDate();

        async function pushTargets() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();
            const startDate = document.getElementById('target-start-date').value;

            // Week 1 Inputs
            const runDist = parseFloat(document.getElementById('run-target-dist').value);
            const cycleLoad = parseInt(document.getElementById('cycle-target-load').value);

            // Week 2 Inputs
            const runDistW2 = parseFloat(document.getElementById('run-target-dist-w2').value);
            const cycleLoadW2 = parseInt(document.getElementById('cycle-target-load-w2').value);

            if (!apiKey || !athleteId) return showToast('‚ùå Missing API Key or Athlete ID');
            if (!startDate) return showToast('‚ùå Missing Start Date');

            if (!runDist && !cycleLoad && !runDistW2 && !cycleLoadW2) {
                return showToast('‚ùå Please set at least one target');
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Pushing...';

            try {
                const promises = [];

                // --- Week 1 ---
                if (runDist) {
                    promises.push(createTargetPromise(apiKey, athleteId, startDate, "Run", runDist));
                }
                if (cycleLoad) {
                    promises.push(createTargetPromise(apiKey, athleteId, startDate, "Ride", cycleLoad));
                }

                // --- Week 2 ---
                if (runDistW2 || cycleLoadW2) {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + 7);
                    const startDateW2 = d.toISOString().split('T')[0];

                    if (runDistW2) {
                        promises.push(createTargetPromise(apiKey, athleteId, startDateW2, "Run", runDistW2));
                    }
                    if (cycleLoadW2) {
                        promises.push(createTargetPromise(apiKey, athleteId, startDateW2, "Ride", cycleLoadW2));
                    }
                }

                await Promise.all(promises);
                showToast('‚úÖ All Targets Pushed Successfully!');

            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function createTargetPromise(apiKey, athleteId, startDate, type, value) {
            const payload = [{
                category: "TARGET",
                start_date_local: `${startDate}T00:00:00`,
                type: type,
                name: `Weekly ${type} Target`,
                external_id: `target_${type.toLowerCase()}_${startDate}`,
            }];

            if (type === "Run") payload[0].distance_target = Math.round(value * 1000);
            if (type === "Ride") payload[0].load_target = value;

            return sendTargetPayload(apiKey, athleteId, payload, type === "Run" ? "Run" : "Cycling", false);
        }

        async function sendTargetPayload(apiKey, athleteId, payload, type, handleButton = true) {
            let btn = null;
            let originalText = "";

            if (handleButton) {
                btn = event.target;
                originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '‚è≥';
            }

            // Show preview (append if multiple)
            const currentPreview = document.getElementById('payload-preview').textContent;
            const newPreview = JSON.stringify(payload, null, 2);
            document.getElementById('payload-preview').textContent = currentPreview ? currentPreview + "\n\n" + newPreview : newPreview;

            try {
                // 1. Delete existing targets for this week to avoid "Duplicate weekly target" error
                // Calculate week start/end dates
                const startDate = payload[0].start_date_local.split('T')[0];
                const d = new Date(startDate);
                const endDate = new Date(d);
                endDate.setDate(d.getDate() + 6);
                const endDateStr = endDate.toISOString().split('T')[0];

                const auth = btoa(`API_KEY:${apiKey}`);

                // Fetch existing events
                const getRes = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events?oldest=${startDate}&newest=${endDateStr}&category=TARGET`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (getRes.ok) {
                    const existingEvents = await getRes.json();
                    // Filter for targets of the same type (Run or Ride)
                    const targetType = payload[0].type;
                    const targetsToDelete = existingEvents.filter(e => e.category === 'TARGET' && e.type === targetType);

                    if (targetsToDelete.length > 0) {
                        console.log(`Deleting ${targetsToDelete.length} existing ${type} targets for ${startDate}...`);
                        for (const t of targetsToDelete) {
                            await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/${t.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Basic ${auth}` }
                            });
                        }
                    }
                }

                // 2. Push new target
                const response = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/bulk?upsert=true`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                if (handleButton) showToast(`‚úÖ ${type} Target Pushed!`);

            } catch (error) {
                throw error; // Re-throw to be caught by caller
            } finally {
                if (handleButton && btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        // Helper for week number
        function getWeekNumber(d) {
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
        }

        // ===================================================================
        // ZONE SYNC FUNCTIONALITY
        // ===================================================================

        // Global state for zone sync
        let calculatedZonesState = null;
        let intervalsZonesState = null;

        /**
         * Friel 7-Zone Running Pace System
         * Based on Lactate Threshold (LT) pace as 100%
         * Returns zones as { id, name, minPct, maxPct, minPace, maxPace }
         */
        const FRIEL_ZONES = [
            { id: 'Z1', name: 'Recovery', minPct: 0, maxPct: 80, purpose: 'Very Slow / Shakeout. Warmup, cooldown, recovery jogs.' },
            { id: 'Z2', name: 'Endurance', minPct: 80, maxPct: 90, purpose: 'Bulk of training. 80-85% Easy, 85-90% Steady/Long Runs.' },
            { id: 'Z3', name: 'Tempo', minPct: 90, maxPct: 95, purpose: 'Marathon Pace Zone. Concentrated, not conversational.' },
            { id: 'Z4', name: 'Sub-Threshold', minPct: 95, maxPct: 100, purpose: 'Cruising Speed. Comfortably hard, ~60 min race pace.' },
            { id: 'Z5a', name: 'Threshold', minPct: 100, maxPct: 102, purpose: 'The Redline. 10k pace. Burning starts here.' },
            { id: 'Z5b', name: 'VO2 Max', minPct: 102, maxPct: 106, purpose: 'Aerobic Capacity. 5k pace intervals. Gasping for air.' },
            { id: 'Z5c', name: 'Anaerobic', minPct: 106, maxPct: 130, purpose: 'Power & Speed. Strides, sprints, final kicks.' }
        ];

        /**
         * Format seconds per km to MM:SS string
         */
        function formatPaceMMSS(secPerKm) {
            if (!secPerKm || secPerKm <= 0) return '--:--';
            const mins = Math.floor(secPerKm / 60);
            const secs = Math.round(secPerKm % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        /**
         * Convert threshold pace to m/s (for API)
         */
        function paceToMeterPerSecond(secPerKm) {
            return 1000 / secPerKm;
        }

        /**
         * Convert m/s to sec/km
         */
        function meterPerSecondToPace(mps) {
            if (!mps || mps <= 0) return 0;
            return 1000 / mps;
        }

        /**
         * Calculate pace from LT pace and percentage
         * Higher % = FASTER pace = LOWER sec/km
         * Formula: pace = ltPace / (pct / 100)
         */
        function calculatePaceFromPct(ltPaceSecPerKm, pct) {
            return ltPaceSecPerKm / (pct / 100);
        }

        /**
         * Calculate zones from threshold pace
         */
        function calculateZonesFromThreshold() {
            const minInput = document.getElementById('lt-pace-min');
            const secInput = document.getElementById('lt-pace-sec');

            const mins = parseInt(minInput.value) || 0;
            const secs = parseInt(secInput.value) || 0;
            const ltPaceSecPerKm = (mins * 60) + secs;

            if (ltPaceSecPerKm < 120 || ltPaceSecPerKm > 600) {
                showToast('‚ùå Please enter a valid LT pace (2:00 - 10:00 /km)');
                return;
            }

            // Calculate zones
            const zones = FRIEL_ZONES.map(z => ({
                ...z,
                minPace: z.maxPct === 130 ? null : calculatePaceFromPct(ltPaceSecPerKm, z.maxPct), // Faster boundary
                maxPace: z.minPct === 0 ? null : calculatePaceFromPct(ltPaceSecPerKm, z.minPct)   // Slower boundary
            }));

            calculatedZonesState = {
                ltPace: ltPaceSecPerKm,
                ltPaceMps: paceToMeterPerSecond(ltPaceSecPerKm),
                zones: zones
            };

            // Render table
            renderCalculatedZones();

            // Show comparison if we have both
            if (intervalsZonesState) {
                renderComparison();
            }

            showToast('‚úÖ Zones calculated from LT pace');
        }

        /**
         * Render calculated zones table
         */
        function renderCalculatedZones() {
            const container = document.getElementById('calculated-zones-container');
            const table = document.getElementById('calculated-zones-table');

            if (!calculatedZonesState) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            let html = `
                <div style="margin-bottom: 10px; color: #4ade80;">
                    <strong>LT Pace:</strong> ${formatPaceMMSS(calculatedZonesState.ltPace)}/km 
                    (${calculatedZonesState.ltPaceMps.toFixed(3)} m/s)
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: rgba(0,0,0,0.3);">
                            <th style="padding: 8px; text-align: left; color: #fff;">Zone</th>
                            <th style="padding: 8px; text-align: left; color: #fff;">Name</th>
                            <th style="padding: 8px; text-align: center; color: #fff;">% of LT</th>
                            <th style="padding: 8px; text-align: center; color: #fff;">Pace Range</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            calculatedZonesState.zones.forEach(z => {
                const minStr = z.minPace ? formatPaceMMSS(z.minPace) : '<fast>';
                const maxStr = z.maxPace ? formatPaceMMSS(z.maxPace) : '<slow>';
                html += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 8px; color: #4ade80;">${z.id}</td>
                        <td style="padding: 8px; color: #cbd5e1;">${z.name}</td>
                        <td style="padding: 8px; text-align: center; color: #a78bfa;">${z.minPct}-${z.maxPct}%</td>
                        <td style="padding: 8px; text-align: center; color: #fbbf24;">${minStr} - ${maxStr}/km</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            // Add push button
            html += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">üì§ Push to Intervals.icu</div>
                    <p style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 15px;">
                        This will set your LT pace to <strong>${formatPaceMMSS(calculatedZonesState.ltPace)}/km</strong> 
                        and configure 7 Friel pace zones in Intervals.icu.
                        <br><em style="color: #94a3b8;">Note: This will overwrite any existing pace zones.</em>
                    </p>
                    <button class="push-btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 12px 24px;"
                        onclick="pushZonesToIntervals()">üöÄ Push Zones to Intervals.icu</button>
                </div>
            `;

            table.innerHTML = html;
        }

        /**
         * Fetch zones from Intervals.icu
         */
        async function fetchIntervalsZones() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID first');
                return;
            }

            showToast('‚è≥ Fetching Intervals.icu zones...');

            try {
                const auth = btoa(`API_KEY:${apiKey}`);

                // Fetch Run sport settings
                const res = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/sport-settings/Run`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const data = await res.json();
                console.log('Intervals.icu Run settings:', data);

                // Extract threshold pace and zones
                // threshold_pace is in m/s
                const ltPaceMps = data.threshold_pace || data.thresholdPace || 0;
                const ltPaceSecPerKm = ltPaceMps > 0 ? meterPerSecondToPace(ltPaceMps) : 0;

                // pace_zones is an array of zone boundary speeds (m/s)
                const paceZones = data.pace_zones || [];

                intervalsZonesState = {
                    ltPace: ltPaceSecPerKm,
                    ltPaceMps: ltPaceMps,
                    paceZonesRaw: paceZones,
                    hasZones: paceZones.length > 0,
                    rawData: data
                };

                renderIntervalsZones();

                // Show comparison if we have both
                if (calculatedZonesState) {
                    renderComparison();
                }

                showToast('‚úÖ Fetched Intervals.icu zones');

            } catch (error) {
                console.error('Zone fetch error:', error);
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        /**
         * Render Intervals.icu zones table
         */
        function renderIntervalsZones() {
            const container = document.getElementById('intervals-zones-container');
            const table = document.getElementById('intervals-zones-table');

            if (!intervalsZonesState) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            let html = `
                <div style="margin-bottom: 10px; color: #60a5fa;">
                    <strong>LT Pace (from Intervals):</strong> ${formatPaceMMSS(intervalsZonesState.ltPace)}/km 
                    (${intervalsZonesState.ltPaceMps.toFixed(3)} m/s)
                </div>
            `;

            if (!intervalsZonesState.hasZones) {
                html += `
                    <div style="padding: 15px; background: rgba(250, 204, 21, 0.1); border-radius: 8px; border: 1px solid rgba(250, 204, 21, 0.3);">
                        <div style="color: #fbbf24; font-weight: bold;">‚ö†Ô∏è No pace zones configured</div>
                        <p style="color: #cbd5e1; font-size: 0.85rem; margin-top: 5px;">
                            Intervals.icu doesn't have pace zones set up yet. You can push your calculated zones below.
                        </p>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin-bottom: 10px; color: #94a3b8; font-size: 0.85rem;">
                        Raw zone boundaries: [${intervalsZonesState.paceZonesRaw.map(v => v.toFixed(1)).join(', ')}]
                    </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: rgba(0,0,0,0.3);">
                            <th style="padding: 8px; text-align: left; color: #fff;">Zone</th>
                            <th style="padding: 8px; text-align: left; color: #fff;">Name</th>
                            <th style="padding: 8px; text-align: center; color: #fff;">% of LT</th>
                            <th style="padding: 8px; text-align: center; color: #fff;">Pace Range</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                // Convert boundaries to zone ranges (each value is upper boundary)
                const zoneIds = ['Z1', 'Z2', 'Z3', 'Z4', 'Z5a', 'Z5b', 'Z5c'];
                const zoneDescriptions = ['Recovery', 'Aerobic', 'Tempo', 'Sub-Threshold', 'Threshold', 'VO2 Max', 'Anaerobic'];

                intervalsZonesState.paceZonesRaw.forEach((upperPct, i) => {
                    const lowerPct = i === 0 ? 0 : intervalsZonesState.paceZonesRaw[i - 1];
                    const isPercent = upperPct > 50;

                    let pctRange, minPace, maxPace;
                    if (isPercent) {
                        const lowerStr = lowerPct === 0 ? '0' : lowerPct.toFixed(0);
                        const upperStr = upperPct >= 999 ? '‚àû' : upperPct.toFixed(0);
                        pctRange = `${lowerStr}-${upperStr}%`;
                        // Higher % = faster = lower sec/km
                        if (intervalsZonesState.ltPace > 0) {
                            maxPace = lowerPct > 0 ? intervalsZonesState.ltPace / (lowerPct / 100) : null;
                            minPace = upperPct < 999 ? intervalsZonesState.ltPace / (upperPct / 100) : null;
                        }
                    } else {
                        pctRange = `${lowerPct.toFixed(1)}-${upperPct.toFixed(1)} m/s`;
                        maxPace = lowerPct > 0 ? meterPerSecondToPace(lowerPct) : null;
                        minPace = meterPerSecondToPace(upperPct);
                    }

                    const minStr = minPace ? formatPaceMMSS(minPace) : '<fast>';
                    const maxStr = maxPace ? formatPaceMMSS(maxPace) : '<slow>';

                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 8px; color: #60a5fa;">${zoneIds[i] || 'Z' + (i + 1)}</td>
                            <td style="padding: 8px; color: #cbd5e1;">${zoneDescriptions[i] || ''}</td>
                            <td style="padding: 8px; text-align: center; color: #a78bfa;">${pctRange}</td>
                            <td style="padding: 8px; text-align: center; color: #fbbf24;">${minStr} - ${maxStr}/km</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
            }

            table.innerHTML = html;
        }

        /**
         * Render comparison table and sync options
         */
        function renderComparison() {
            const container = document.getElementById('zone-comparison-container');
            const table = document.getElementById('zone-comparison-table');
            const syncOptions = document.getElementById('sync-options');

            if (!calculatedZonesState) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            // Build comparison table
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: rgba(0,0,0,0.3);">
                            <th style="padding: 8px; text-align: left; color: #fff;">Metric</th>
                            <th style="padding: 8px; text-align: center; color: #4ade80;">Calculated (Friel)</th>
                            <th style="padding: 8px; text-align: center; color: #60a5fa;">Intervals.icu</th>
                            <th style="padding: 8px; text-align: center; color: #fbbf24;">Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // LT Pace comparison
            const calcLT = calculatedZonesState.ltPace;
            const intLT = intervalsZonesState?.ltPace || 0;
            const ltDiff = intLT > 0 ? Math.round(calcLT - intLT) : '--';
            const ltMatch = Math.abs(ltDiff) <= 2 ? '‚úÖ' : (ltDiff === '--' ? '‚ö†Ô∏è' : '‚ùå');

            html += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <td style="padding: 8px; color: #fff; font-weight: bold;">LT Pace</td>
                    <td style="padding: 8px; text-align: center; color: #4ade80;">${formatPaceMMSS(calcLT)}/km</td>
                    <td style="padding: 8px; text-align: center; color: #60a5fa;">${intLT > 0 ? formatPaceMMSS(intLT) + '/km' : 'Not set'}</td>
                    <td style="padding: 8px; text-align: center;">${ltMatch} ${ltDiff !== '--' ? ltDiff + 's' : ltDiff}</td>
                </tr>
            `;

            // Zones match
            const hasMatchingZones = intervalsZonesState?.hasZones && intervalsZonesState.paceZonesRaw.length >= 5;
            html += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <td style="padding: 8px; color: #fff; font-weight: bold;">Pace Zones</td>
                    <td style="padding: 8px; text-align: center; color: #4ade80;">7 zones (Friel)</td>
                    <td style="padding: 8px; text-align: center; color: #60a5fa;">${hasMatchingZones ? intervalsZonesState.paceZonesRaw.length + ' boundaries' : 'Not configured'}</td>
                    <td style="padding: 8px; text-align: center;">${hasMatchingZones ? '‚úÖ Has zones' : '‚ö†Ô∏è Missing'}</td>
                </tr>
            `;

            html += `</tbody></table>`;
            table.innerHTML = html;

            // Sync options
            if (!intervalsZonesState?.hasZones || !intervalsZonesState.ltPace || Math.abs(calcLT - intLT) > 5) {
                syncOptions.innerHTML = `
                    <div style="padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                        <div style="color: #4ade80; font-weight: bold; margin-bottom: 10px;">üöÄ Push Calculated Zones to Intervals.icu</div>
                        <p style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 15px;">
                            This will update your Intervals.icu Run settings with:
                            <br>‚Ä¢ Threshold Pace: ${formatPaceMMSS(calcLT)}/km (${calculatedZonesState.ltPaceMps.toFixed(3)} m/s)
                            <br>‚Ä¢ 7 Friel pace zones
                        </p>
                        <button class="push-btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 12px 24px;"
                            onclick="pushZonesToIntervals()">üì§ Push Zones to Intervals.icu</button>
                    </div>
                `;
            } else {
                syncOptions.innerHTML = `
                    <div style="padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                        <div style="color: #4ade80; font-weight: bold;">‚úÖ Zones are in sync!</div>
                        <p style="color: #cbd5e1; font-size: 0.85rem; margin-top: 5px;">
                            Your calculated zones match Intervals.icu (within 5 seconds tolerance).
                        </p>
                    </div>
                `;
            }
        }

        /**
         * Push calculated zones to Intervals.icu
         */
        async function pushZonesToIntervals() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID first');
                return;
            }

            if (!calculatedZonesState) {
                showToast('‚ùå Please calculate zones first');
                return;
            }

            showToast('‚è≥ Pushing zones to Intervals.icu...');

            try {
                const auth = btoa(`API_KEY:${apiKey}`);

                // Build pace_zones array as PERCENTAGES (matching Intervals.icu format)
                // Friel 7-zone upper boundaries: [85, 90, 95, 100, 102, 106, 999]
                const paceZonesPct = calculatedZonesState.zones.map(z => {
                    // Use maxPct as the upper boundary for each zone
                    // Z5c (130%) uses 999 as infinity marker
                    return z.maxPct >= 130 ? 999 : z.maxPct;
                });

                // Build the payload
                // threshold_pace = LT speed in m/s
                // pace_zones = array of upper % boundaries
                // pace_zone_names = array of zone names (required by API)
                const paceZoneNames = calculatedZonesState.zones.map(z => z.name);

                const payload = {
                    threshold_pace: calculatedZonesState.ltPaceMps,
                    pace_zones: paceZonesPct,
                    pace_zone_names: paceZoneNames
                };

                console.log('Pushing zones payload:', payload);
                console.log('  LT Pace:', formatPaceMMSS(calculatedZonesState.ltPace), '/km (', calculatedZonesState.ltPaceMps.toFixed(3), 'm/s)');
                console.log('  Zones:', paceZonesPct.join(', '));
                console.log('  Names:', paceZoneNames.join(', '));

                const res = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/sport-settings/Run`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Push error:', errorText);
                    throw new Error(`API Error: ${res.status} - ${errorText}`);
                }

                const result = await res.json();
                console.log('Push result:', result);

                showToast('‚úÖ Zones pushed to Intervals.icu!');

                // Refresh to confirm
                await fetchIntervalsZones();

            } catch (error) {
                console.error('Zone push error:', error);
                showToast(`‚ùå Error: ${error.message}`);
            }
        }

        /**
         * Run full zone sync check - the main background sync logic
         */
        async function runZoneSyncCheck() {
            const statusDiv = document.getElementById('sync-check-status');
            const dialogDiv = document.getElementById('sync-choice-dialog');
            const dialogContent = document.getElementById('sync-choice-content');

            // Reset UI
            statusDiv.style.display = 'block';
            dialogDiv.style.display = 'none';

            // Step 1: Check if threshold is calculated
            if (!calculatedZonesState) {
                statusDiv.innerHTML = `
                    <div style="color: #f87171;">‚ùå Please calculate your zones first (Step 1)</div>
                `;
                return;
            }

            // Step 2: Check API credentials
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                statusDiv.innerHTML = `
                    <div style="color: #f87171;">‚ùå Please enter API Key and Athlete ID first</div>
                `;
                return;
            }

            statusDiv.innerHTML = `<div style="color: #60a5fa;">‚è≥ Fetching Intervals.icu zones...</div>`;

            // Step 3: Fetch Intervals.icu zones
            try {
                const auth = btoa(`API_KEY:${apiKey}`);
                const res = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/sport-settings/Run`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (!res.ok) throw new Error(`API Error: ${res.status}`);

                const data = await res.json();
                const ltPaceMps = data.threshold_pace || 0;
                const ltPaceSecPerKm = ltPaceMps > 0 ? 1000 / ltPaceMps : 0;
                const paceZones = data.pace_zones || [];

                console.log('Sync Check - Intervals.icu data:', { ltPaceSecPerKm, paceZones });

                // Step 4: Analyze the situation
                const hasZones = paceZones.length >= 5;
                const hasLtPace = ltPaceSecPerKm > 0;

                // Tolerance constants
                const LT_TOLERANCE = 1; // 1 second
                const ZONE_TOLERANCE = 1; // 1% tolerance for zone boundaries

                // Calculate differences
                const ltDiff = hasLtPace ? Math.abs(calculatedZonesState.ltPace - ltPaceSecPerKm) : Infinity;
                const ltMatch = ltDiff <= LT_TOLERANCE;

                // Check zone boundaries
                let zonesMatch = true;
                if (hasZones) {
                    const calcPcts = calculatedZonesState.zones.map(z => z.maxPct);
                    for (let i = 0; i < Math.min(paceZones.length, calcPcts.length); i++) {
                        const intPct = paceZones[i];
                        const calcPct = calcPcts[i] >= 130 ? 999 : calcPcts[i];
                        if (Math.abs(intPct - calcPct) > ZONE_TOLERANCE && intPct < 999) {
                            zonesMatch = false;
                            break;
                        }
                    }
                }

                // Decision tree
                if (!hasZones || !hasLtPace) {
                    // Scenario 1: No zones set - AUTO PUSH
                    statusDiv.innerHTML = `
                        <div style="color: #fbbf24;">üì§ No zones configured on Intervals.icu - auto-pushing...</div>
                    `;
                    await pushZonesToIntervals();
                    statusDiv.innerHTML = `
                        <div style="color: #4ade80;">‚úÖ Zones auto-pushed to Intervals.icu (no previous zones found)</div>
                    `;

                } else if (ltMatch && zonesMatch) {
                    // Scenario 2: Everything matches
                    statusDiv.innerHTML = `
                        <div style="color: #4ade80;">‚úÖ Zones are already synced! LT pace and zone boundaries match.</div>
                        <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">
                            LT: ${formatPaceMMSS(calculatedZonesState.ltPace)}/km (diff: ${ltDiff}s)
                        </div>
                    `;

                } else {
                    // Scenario 3: Mismatch - show comparison dialog
                    statusDiv.innerHTML = `
                        <div style="color: #fbbf24;">‚ö†Ô∏è Zone mismatch detected - please choose below</div>
                    `;

                    // Store intervals data for comparison
                    intervalsZonesState = {
                        ltPace: ltPaceSecPerKm,
                        ltPaceMps: ltPaceMps,
                        paceZonesRaw: paceZones,
                        hasZones: hasZones,
                        rawData: data
                    };

                    showSyncChoiceDialog(ltDiff, ltMatch, zonesMatch);
                }

            } catch (error) {
                console.error('Sync check error:', error);
                statusDiv.innerHTML = `
                    <div style="color: #f87171;">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        /**
         * Show the sync choice dialog with comparison table
         */
        function showSyncChoiceDialog(ltDiff, ltMatch, zonesMatch) {
            const dialogDiv = document.getElementById('sync-choice-dialog');
            const dialogContent = document.getElementById('sync-choice-content');

            dialogDiv.style.display = 'block';

            // Build Our Zones table
            let ourZonesHtml = `
                <h5 style="color: #4ade80; margin: 10px 0;">üìä Our Calculated Zones (Friel 7-Zone)</h5>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 15px;">
                    <thead>
                        <tr style="background: rgba(74, 222, 128, 0.2);">
                            <th style="padding: 6px; text-align: left; color: #4ade80;">Zone</th>
                            <th style="padding: 6px; text-align: left; color: #4ade80;">Name</th>
                            <th style="padding: 6px; text-align: center; color: #4ade80;">% of LT</th>
                            <th style="padding: 6px; text-align: center; color: #4ade80;">Pace</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            calculatedZonesState.zones.forEach(z => {
                const minStr = z.minPace ? formatPaceMMSS(z.minPace) : '<fast>';
                const maxStr = z.maxPace ? formatPaceMMSS(z.maxPace) : '<slow>';
                ourZonesHtml += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 6px; color: #4ade80;">${z.id}</td>
                        <td style="padding: 6px; color: #cbd5e1;">${z.name}</td>
                        <td style="padding: 6px; text-align: center; color: #a78bfa;">${z.minPct}-${z.maxPct}%</td>
                        <td style="padding: 6px; text-align: center; color: #fbbf24;">${minStr} - ${maxStr}</td>
                    </tr>
                `;
            });
            ourZonesHtml += `</tbody></table>`;

            // Build Intervals.icu Zones table
            const intZones = intervalsZonesState.paceZonesRaw;
            let intZonesHtml = `
                <h5 style="color: #60a5fa; margin: 10px 0;">üîó Intervals.icu Zones (${intZones.length} boundaries)</h5>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 15px;">
                    <thead>
                        <tr style="background: rgba(96, 165, 250, 0.2);">
                            <th style="padding: 6px; text-align: left; color: #60a5fa;">Zone</th>
                            <th style="padding: 6px; text-align: center; color: #60a5fa;">% of LT</th>
                            <th style="padding: 6px; text-align: center; color: #60a5fa;">Pace</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            intZones.forEach((upperPct, i) => {
                const lowerPct = i === 0 ? 0 : intZones[i - 1];
                const isPercent = upperPct > 50;

                let pctRange, minPace, maxPace;
                if (isPercent) {
                    const lowerStr = lowerPct === 0 ? '0' : lowerPct.toFixed(0);
                    const upperStr = upperPct >= 999 ? '‚àû' : upperPct.toFixed(0);
                    pctRange = `${lowerStr}-${upperStr}%`;
                    if (intervalsZonesState.ltPace > 0) {
                        maxPace = lowerPct > 0 ? intervalsZonesState.ltPace / (lowerPct / 100) : null;
                        minPace = upperPct < 999 ? intervalsZonesState.ltPace / (upperPct / 100) : null;
                    }
                } else {
                    pctRange = `${lowerPct.toFixed(1)}-${upperPct.toFixed(1)} m/s`;
                    maxPace = lowerPct > 0 ? 1000 / lowerPct : null;
                    minPace = 1000 / upperPct;
                }

                const minStr = minPace ? formatPaceMMSS(minPace) : '<fast>';
                const maxStr = maxPace ? formatPaceMMSS(maxPace) : '<slow>';

                // Show zone labels: Z1, Z2, Z3, Z4, Z5 (Z5a), Z6 (Z5b), Z7 (Z5c), Z8+
                const zoneLabel = i < 4 ? `Z${i + 1}` :
                    i === 4 ? 'Z5 (Z5a)' :
                        i === 5 ? 'Z6 (Z5b)' :
                            i === 6 ? 'Z7 (Z5c)' :
                                `Z${i + 1}`;

                intZonesHtml += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 6px; color: #60a5fa;">${zoneLabel}</td>
                        <td style="padding: 6px; text-align: center; color: #a78bfa;">${pctRange}</td>
                        <td style="padding: 6px; text-align: center; color: #fbbf24;">${minStr} - ${maxStr}</td>
                    </tr>
                `;
            });
            intZonesHtml += `</tbody></table>`;

            // Build the full dialog
            let html = `
                <p style="color: #cbd5e1; margin-bottom: 15px;">
                    Your calculated zones differ from Intervals.icu. This may happen if:
                    <br>‚Ä¢ You did a lab test and set custom zones in Intervals.icu
                    <br>‚Ä¢ The tool calculated different values
                </p>
                
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <strong style="color: #fff;">LT Pace:</strong> 
                    <span style="color: #4ade80;">Ours: ${formatPaceMMSS(calculatedZonesState.ltPace)}/km</span> vs 
                    <span style="color: #60a5fa;">Intervals: ${formatPaceMMSS(intervalsZonesState.ltPace)}/km</span>
                    <span style="margin-left: 10px;">${ltMatch ? '‚úÖ' : '‚ùå'} (${Math.round(ltDiff)}s diff)</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>${ourZonesHtml}</div>
                    <div>${intZonesHtml}</div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                    <button class="push-btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 12px 24px; flex: 1; min-width: 200px;"
                        onclick="adoptOurZones()">
                        üì§ Push Our Zones<br>
                        <span style="font-size: 0.75rem; opacity: 0.8;">Use calculated Friel zones</span>
                    </button>
                    <button class="push-btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 12px 24px; flex: 1; min-width: 200px;"
                        onclick="adoptIntervalsZones()">
                        üì• Import Intervals.icu<br>
                        <span style="font-size: 0.7rem; opacity: 0.8; line-height: 1.3;">I have set these zones consciously,<br>based on a lab/field test</span>
                    </button>
                </div>
                
                <p style="color: #94a3b8; font-size: 0.8rem; margin-top: 15px; font-style: italic;">
                    üí° Tip: If you did a lab test, choose "Import Intervals.icu" to use your tested zones.
                </p>
            `;

            dialogContent.innerHTML = html;
        }

        /**
         * User chose to push our calculated zones
         */
        async function adoptOurZones() {
            const dialogDiv = document.getElementById('sync-choice-dialog');
            const statusDiv = document.getElementById('sync-check-status');

            await pushZonesToIntervals();

            dialogDiv.style.display = 'none';
            statusDiv.innerHTML = `
                <div style="color: #4ade80;">‚úÖ Zones synced! Pushed calculated Friel zones to Intervals.icu</div>
            `;
        }

        /**
         * User chose to import Intervals.icu zones
         */
        function adoptIntervalsZones() {
            const dialogDiv = document.getElementById('sync-choice-dialog');
            const statusDiv = document.getElementById('sync-check-status');

            if (!intervalsZonesState || !intervalsZonesState.ltPace) {
                showToast('‚ùå No Intervals.icu zones to import');
                return;
            }

            // Update the threshold input fields with Intervals.icu LT pace
            const ltPaceSecPerKm = intervalsZonesState.ltPace;
            const mins = Math.floor(ltPaceSecPerKm / 60);
            const secs = Math.round(ltPaceSecPerKm % 60);

            document.getElementById('lt-pace-min').value = mins;
            document.getElementById('lt-pace-sec').value = secs;

            // Recalculate zones with the imported LT pace
            calculateZonesFromThreshold();

            dialogDiv.style.display = 'none';
            statusDiv.innerHTML = `
                <div style="color: #4ade80;">‚úÖ Imported Intervals.icu zones!</div>
                <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">
                    LT Pace updated to ${formatPaceMMSS(ltPaceSecPerKm)}/km. Your calculated zones now match Intervals.icu.
                </div>
            `;

            showToast('‚úÖ Imported Intervals.icu zones');
        }
    </script>
</body>

</html>