<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite AI Coach - Zurich '26 (V63)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="h-screen flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white">


    <!-- Global Error Handler -->
    <div id="crashOverlay" class="fixed inset-0 bg-red-900/90 z-[100] flex items-center justify-center p-8">
        <div class="bg-white text-red-900 p-6 rounded-lg shadow-xl max-w-2xl">
            <h2 class="text-2xl font-bold mb-2">System Error</h2>
            <pre id="crashMsg" class="bg-gray-100 p-4 rounded text-xs font-mono overflow-auto max-h-64 mb-4"></pre>
            <button type="button" onclick="localStorage.clear(); location.reload()"
                class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Reset App</button>
        </div>
    </div>


    <!-- Toast -->
    <div id="toast"
        class="fixed top-4 right-4 transform translate-x-full transition-transform duration-300 z-[90] bg-blue-600 text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 border border-blue-400">
        <i class="fa-solid fa-check-circle"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <!-- AI Loading Overlay -->
    <div id="aiLoadingOverlay"
        class="hidden fixed inset-0 bg-slate-900/95 z-[95] flex items-center justify-center backdrop-blur-sm">
        <div class="text-center">
            <div
                class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mb-4">
            </div>
            <h3 id="loadingMessage" class="text-xl font-bold text-white mb-2">Generating AI Plan...</h3>
            <p class="text-sm text-slate-400 mb-6">Please wait, this may take a moment.<br>AI generation can sometimes
                be slow.</p>

            <button onclick="hideAILoading()"
                class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold rounded border border-slate-600 transition-colors">
                Return to Plan
            </button>
        </div>
    </div>


    <!-- Header -->
    <header class="border-b border-slate-700 bg-slate-900/80 backdrop-blur-md z-20 shrink-0">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-2 h-8 bg-blue-600 rounded-sm"></div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight text-white">AI COACH <span
                            class="text-blue-500">PRO</span></h1>
                    <p class="text-[10px] text-slate-400 mono uppercase tracking-widest">V63: Export Syntax Fix</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="fetchData(true)"
                    class="flex items-center gap-2 px-3 py-1.5 text-xs font-bold bg-slate-800 hover:bg-slate-700 text-blue-400 rounded transition-colors border border-slate-700">
                    <i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Fetch Data</span>
                </button>
                <button onclick="openSetup()" class="p-2 text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
    </header>


    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">

        <!-- Sidebar -->
        <aside
            class="w-full md:w-80 flex-shrink-0 border-r border-slate-700 bg-slate-900 overflow-y-auto hidden md:flex flex-col">
            <div class="p-5 space-y-6">

                <!-- Readiness -->
                <div class="relative group cursor-pointer" onclick="triggerCheckIn()">
                    <div
                        class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl blur opacity-20 group-hover:opacity-40 transition duration-500">
                    </div>
                    <div class="relative bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Readiness</h3>
                            <span id="readinessBadge"
                                class="bg-slate-700 text-slate-300 text-[10px] px-2 py-0.5 rounded uppercase font-bold">Checking...</span>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <span id="readinessScore" class="text-3xl font-bold text-white">--</span>
                            <span class="text-xs text-slate-500">/ 100</span>
                        </div>
                    </div>
                </div>


                <!-- Consolidated Zones Table (ALL 5 ZONES) -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mono">Training
                            Zones</h3>
                        <span id="zoneSource" class="text-[9px] text-slate-600 uppercase"></span>
                    </div>
                    <div class="bg-slate-800/50 rounded border border-slate-700 overflow-hidden">
                        <table class="w-full zone-table">
                            <thead class="bg-slate-900 border-b border-slate-700">
                                <tr>
                                    <th>Zone</th>
                                    <th>Pace (min/km)</th>
                                    <th>HR (bpm)</th>
                                </tr>
                            </thead>
                            <tbody id="zoneTableBody">
                                <!-- Injected via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div
                        class="mt-2 flex justify-between items-center px-2 py-1 bg-slate-800/50 rounded border border-slate-700">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">LT Threshold</div>
                        <div class="text-xs font-mono text-white">
                            <span id="disp-lthr-pace">--:--</span> <span class="text-slate-600">|</span> <span
                                id="disp-lthr-bpm">--</span> <span class="text-[9px] text-slate-500">bpm</span>
                        </div>
                    </div>
                </div>

                <!-- Weekly Volume & Suggested -->
                <div class="bg-slate-800/50 p-3 rounded border border-slate-700 mb-4">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 mono">Volume Control
                    </h3>

                    <div class="flex justify-between items-start gap-4 mb-3">
                        <!-- Current Stats -->
                        <div class="flex-1">
                            <div class="text-[10px] text-slate-400 uppercase font-bold mb-1" id="vol-last-week-label">
                                Last Week</div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-2xl font-bold text-white" id="vol-last-week-km">--</span>
                                <span class="text-xs text-slate-500">km</span>
                            </div>
                            <div class="text-[9px] text-slate-600 mono mt-0.5" id="vol-last-week-dates">--</div>
                        </div>

                        <!-- 4wk Avg -->
                        <div class="text-right">
                            <div class="text-[9px] text-slate-500 uppercase mb-1">4wk Avg</div>
                            <div class="font-mono text-sm text-slate-300"><span id="vol-4wk-avg">--</span> km</div>
                        </div>
                    </div>

                    <!-- Suggested Next Week -->
                    <div class="space-y-2 pt-3 border-t border-slate-700/50">
                        <div class="text-[9px] text-slate-500 uppercase font-bold">Progression Rate</div>
                        <div class="flex gap-2">
                            <!-- Easy -->
                            <div class="flex-1 flex items-center justify-center gap-2 bg-slate-900/50 p-2 rounded border border-green-900/30 cursor-pointer hover:bg-green-900/20 transition-colors group"
                                onclick="setProgressionRate(0.05)">
                                <div
                                    class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.5)] group-hover:scale-125 transition-transform">
                                </div>
                                <span class="text-green-200 font-bold text-[10px]">Easy</span>
                            </div>

                            <!-- Normal -->
                            <div class="flex-1 flex items-center justify-center gap-2 bg-slate-900/50 p-2 rounded border border-yellow-900/30 cursor-pointer hover:bg-yellow-900/20 transition-colors group"
                                onclick="setProgressionRate(0.075)">
                                <div
                                    class="w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_5px_rgba(234,179,8,0.5)] group-hover:scale-125 transition-transform">
                                </div>
                                <span class="text-yellow-200 font-bold text-[10px]">Normal</span>
                            </div>

                            <!-- Aggressive -->
                            <div class="flex-1 flex items-center justify-center gap-2 bg-slate-900/50 p-2 rounded border border-red-900/30 cursor-pointer hover:bg-red-900/20 transition-colors group"
                                onclick="setProgressionRate(0.10)">
                                <div
                                    class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.5)] group-hover:scale-125 transition-transform">
                                </div>
                                <span class="text-red-200 font-bold text-[10px]">Hard</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Debugging Tool -->
                <div class="p-2 border border-slate-700 bg-slate-900/50 rounded mt-4">
                    <div class="text-[10px] font-bold text-slate-500 mb-1">DEBUGGING TOOL</div>
                    <div class="text-[9px] font-mono text-green-400">Z2: <span id="dbg-z2">--</span></div>
                    <div class="text-[9px] font-mono text-red-400">Z5: <span id="dbg-z5">--</span></div>

                    <div class="mt-2 text-[10px] font-bold text-slate-500 mb-1">LAST WEEK ACTS (km)</div>
                    <div id="dbg-last-week-acts" class="text-[9px] font-mono text-blue-300 break-all">--</div>

                    <div class="mt-2 text-[10px] font-bold text-slate-500 mb-1">RAW HR ZONES</div>
                    <pre id="rawHrOutput"
                        class="text-[8px] font-mono text-slate-400 overflow-x-auto whitespace-pre-wrap break-all">--</pre>
                    <div class="mt-2 text-[10px] font-bold text-slate-500 mb-1">RAW PACE ZONES</div>
                    <pre id="rawPaceOutput"
                        class="text-[8px] font-mono text-slate-400 overflow-x-auto whitespace-pre-wrap break-all">--</pre>

                    <div class="mt-2 text-[10px] font-bold text-slate-500 mb-1">AI PROMPT</div>
                    <div id="dbg-ai-prompt"
                        class="text-[8px] font-mono text-yellow-200/70 overflow-x-auto whitespace-pre-wrap break-all max-h-32 overflow-y-auto">
                        --</div>
                </div>


                <!-- Biometrics (HIDDEN) -->
                <div class="hidden">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 mono">Biometrics
                        (42d)</h3>
                    <div class="space-y-2">
                        <div
                            class="bg-slate-800/50 p-2 rounded border border-slate-700 flex justify-between items-center">
                            <div class="text-xs text-slate-400">Resting HR</div>
                            <div class="font-bold text-sm text-white mono" id="bio-rhr">--</div>
                        </div>
                        <div
                            class="bg-slate-800/50 p-2 rounded border border-slate-700 flex justify-between items-center">
                            <div class="text-xs text-slate-400">HRV (rMSSD)</div>
                            <div class="font-bold text-sm text-white mono" id="bio-hrv">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>


        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-950 p-4 md:p-8 scroll-smooth relative">
            <div class="h-full">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-8 flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1" id="currentPhaseTitle">Personalize Training
                                Plan
                            </h2>
                        </div>
                        <button type="button" onclick="pushWeeklyTargetsToIntervals()"
                            class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 text-xs font-bold py-2 px-4 rounded border border-blue-500/30 transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-bullseye"></i> Push Targets
                        </button>
                    </div>
                    <div id="planContainer" class="space-y-1 relative"></div>
                </div>
            </div>
        </main>
    </div>


    <!-- MODALS -->

    <!-- Setup Modal (Wide with Side Panel) -->
    <div id="setupModal"
        class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">

        <!-- Main Container (Flex Row) -->
        <div class="flex gap-4 w-full max-w-6xl h-[90vh]">

            <!-- Configurator Column -->
            <div
                class="bg-slate-900 border border-slate-700 rounded-xl flex-1 overflow-y-auto shadow-2xl flex flex-col">
                <div class="p-6 space-y-6 flex-1">

                    <!-- Header -->
                    <div class="flex justify-between items-center border-b border-slate-800 pb-4">
                        <h2 class="text-xl font-bold text-white tracking-tight">Configuration</h2>
                        <button onclick="closeSetup()" class="text-slate-400 hover:text-white transition-colors">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <!-- 1. Race Goal -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 text-purple-400">
                            <i class="fa-solid fa-flag-checkered"></i>
                            <label class="text-sm font-bold uppercase tracking-wider">1. Race Goal</label>
                        </div>

                        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 grid grid-cols-4 gap-4">
                            <!-- Sport Type -->
                            <div>
                                <label class="block text-slate-400 text-xs font-bold mb-2">
                                    <i class="fa-solid fa-person-running text-teal-400 mr-1"></i> Sport Type
                                </label>
                                <select id="sportTypeInput" onchange="toggleSportFields()"
                                    class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:outline-none focus:border-teal-500 transition-colors text-sm">
                                    <option value="Running">Running</option>
                                    <option value="Cycling">Cycling</option>
                                </select>
                            </div>

                            <!-- Distance (Dynamic) -->
                            <div>
                                <label class="block text-slate-400 text-xs font-bold mb-2">
                                    <i class="fa-solid fa-route text-pink-400 mr-1"></i> Distance
                                </label>

                                <!-- Running Distance -->
                                <div id="runDistanceContainer">
                                    <select id="raceTypeInput"
                                        class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:outline-none focus:border-pink-500 transition-colors text-sm">
                                        <option value="Marathon">Marathon</option>
                                        <option value="Half Marathon">Half Marathon</option>
                                        <option value="10k">10k</option>
                                    </select>
                                </div>

                                <!-- Cycling Distance -->
                                <div id="cycleDistanceContainer" class="hidden">
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="cycleDistanceInput" placeholder="e.g. 100"
                                            class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:outline-none focus:border-pink-500 transition-colors text-sm">
                                        <span class="text-xs text-slate-500">km</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-slate-400 text-xs font-bold mb-2">
                                    <i class="fa-solid fa-flag-checkered text-blue-400 mr-1"></i> Race Date
                                </label>
                                <input type="date" id="raceDateInput"
                                    class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:outline-none focus:border-blue-500 transition-colors text-sm">
                            </div>

                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Goal
                                    Time</label>
                                <input type="text" id="goalTimeInput"
                                    class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-purple-500 outline-none transition-colors"
                                    placeholder="03:30">
                            </div>

                            <!-- Goal Assessment Feedback -->
                            <div id="goalFeedback" class="col-span-2 hidden">
                                <div class="p-3 rounded-lg border border-slate-600/50 bg-slate-900/50">
                                    <div class="flex items-start gap-2 mb-2">
                                        <i class="fa-solid fa-chart-line text-purple-400 mt-0.5"></i>
                                        <div class="flex-1">
                                            <div id="feedbackStatus" class="text-sm font-bold mb-1"></div>
                                            <div id="feedbackMessage" class="text-xs text-slate-300 mb-2"></div>
                                            <div id="feedbackWarnings" class="space-y-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Athlete Profile -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 text-teal-400">
                            <i class="fa-solid fa-user-gear"></i>
                            <label class="text-sm font-bold uppercase tracking-wider">2. Athlete Profile &
                                Availability</label>
                        </div>

                        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Training
                                        History</label>
                                    <textarea id="historyInput" rows="2"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-teal-500 outline-none transition-colors"
                                        placeholder="e.g. Running for 3 years..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Injuries
                                        /
                                        Limitations</label>
                                    <textarea id="injuriesInput" rows="2"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-teal-500 outline-none transition-colors"
                                        placeholder="e.g. Shin splints..."></textarea>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Gym
                                        Access</label>
                                    <select id="gymAccessInput"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-teal-500 outline-none transition-colors">
                                        <option value="none">None (Bodyweight only)</option>
                                        <option value="basic">Basic (Dumbbells/Bands)</option>
                                        <option value="full">Full Gym (Squat Rack, Machines)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Training
                                        Preferences</label>
                                    <textarea id="preferencesInput" rows="1"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-teal-500 outline-none transition-colors"
                                        placeholder="e.g. No runs on Fridays..."></textarea>
                                </div>
                            </div>

                            <!-- Weekly Schedule -->
                            <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-700/50">
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-2">Default
                                        Available Days</label>
                                    <div class="grid grid-cols-7 gap-2">
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="dayMon" class="mb-1 accent-orange-500" checked>
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Mon</span>
                                        </label>
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="dayTue" class="mb-1 accent-orange-500">
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Tue</span>
                                        </label>
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="dayWed" class="mb-1 accent-orange-500" checked>
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Wed</span>
                                        </label>
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="dayThu" class="mb-1 accent-orange-500">
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Thu</span>
                                        </label>
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="dayFri" class="mb-1 accent-orange-500" checked>
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Fri</span>
                                        </label>
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="daySat" class="mb-1 accent-orange-500">
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Sat</span>
                                        </label>
                                        <label class="flex flex-col items-center cursor-pointer group">
                                            <input type="checkbox" id="daySun" class="mb-1 accent-orange-500" checked>
                                            <span
                                                class="text-[10px] text-slate-400 group-hover:text-white transition-colors">Sun</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Long Run
                                        / Ride Day</label>
                                    <select id="longRunDayInput"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-orange-500 outline-none transition-colors">
                                        <option value="0" selected>Sunday</option>
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Connection & History -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 text-blue-400">
                            <i class="fa-solid fa-link"></i>
                            <label class="text-sm font-bold uppercase tracking-wider">3. Connection & History</label>
                        </div>

                        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 space-y-4">
                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Intervals.icu
                                    API Key & Athlete ID</label>
                                <div class="flex gap-2">
                                    <input type="password" id="apiKeyInput"
                                        class="w-[50%] bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors"
                                        placeholder="API Key">
                                    <input type="text" id="athleteIdInput"
                                        class="w-[25%] bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors"
                                        placeholder="Athlete ID">
                                    <button id="checkConnectionBtn" onclick="checkConnectionAndHistory()"
                                        class="w-[25%] bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition-colors whitespace-nowrap flex items-center justify-center">
                                        <i class="fa-solid fa-plug mr-1"></i> Check History
                                    </button>
                                </div>
                                <div id="connectionStatus" class="hidden mt-2 text-xs"></div>
                            </div>

                            <!-- Smart Plan Results (Hidden Initially) -->
                            <div id="smart-plan-result" class="hidden space-y-4 pt-2 border-t border-slate-700/50">
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Recent History
                                            (Last 4 Weeks)</div>
                                        <div id="weekly-breakdown" class="text-xs text-slate-300 space-y-1 font-mono">
                                        </div>
                                    </div>
                                    <div class="w-1/4 bg-slate-800/50 rounded p-2 border border-slate-700">
                                        <div class="text-[9px] text-slate-500 uppercase font-bold mb-1">Peak Stats</div>
                                        <div id="history-peak-stats" class="space-y-1"></div>
                                    </div>
                                </div>
                                <div id="history-summary-text" class="hidden"></div>
                                <div id="rest-week-suggestion"
                                    class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded p-3 text-xs text-yellow-200">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Planning Inputs (Hidden Initially) -->
                    <div id="step-4-inputs" class="hidden space-y-4">
                        <div class="flex items-center gap-2 text-green-400">
                            <i class="fa-solid fa-sliders"></i>
                            <label class="text-sm font-bold uppercase tracking-wider">4. Plan Configuration</label>
                        </div>

                        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 space-y-4">

                            <!-- Cycling Configuration (Single Row) -->
                            <div id="cycling-config-container" class="grid grid-cols-5 gap-4 hidden">
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Plan
                                        Start Date</label>
                                    <input type="date" id="planStartDateInputCycle"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors font-mono">
                                </div>
                                <div id="currentFitnessContainer">
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Current
                                        Fitness (CTL)</label>
                                    <input type="number" id="current-fitness" placeholder="--"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors font-mono">
                                </div>
                                <div id="start-long-run-container">
                                    <label id="lbl-start-lr" class="block text-xs text-slate-400 mb-1">Start Long Ride
                                        (Hours)</label>
                                    <input type="number" id="target-long-run"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors"
                                        placeholder="e.g. 2">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Ramp Rate
                                        (TSS/wk)</label>
                                    <select id="progressionRateInputCycle"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors">
                                        <option value="3">3 pts (Conservative)</option>
                                        <option value="5" selected>5 pts (Optimal)</option>
                                        <option value="7">7 pts (Aggressive)</option>
                                    </select>
                                </div>
                                <div id="taperContainer">
                                    <label class="block text-xs text-slate-400 mb-1">Taper Duration</label>
                                    <select id="taperDurationInputCycle"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors font-mono">
                                        <option value="3">3 Weeks</option>
                                        <option value="2">2 Weeks</option>
                                        <option value="1" selected>1 Week</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Running Configuration (Single Row) -->
                            <div id="running-config-container" class="grid grid-cols-6 gap-4">
                                <div>
                                    <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Plan
                                        Start Date</label>
                                    <input type="date" id="planStartDateInputRun"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors font-mono">
                                </div>
                                <div id="start-volume-container">
                                    <label id="lbl-start-vol" class="block text-xs text-slate-400 mb-1">Start Volume
                                        (km)</label>
                                    <input type="number" id="target-volume"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors"
                                        placeholder="e.g. 30">
                                </div>
                                <div id="start-long-run-container-run">
                                    <label class="block text-xs text-slate-400 mb-1">Start Long Run (km)</label>
                                    <input type="number" id="target-long-run-run"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors"
                                        placeholder="e.g. 10">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Weekly Progression</label>
                                    <select id="progressionRateInputRun"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors">
                                        <option value="0.05">5% (Easy)</option>
                                        <option value="0.075">7.5% (Normal)</option>
                                        <option value="0.10" selected>10% (Aggr.)</option>
                                    </select>
                                </div>
                                <div id="lr-progression-container">
                                    <label class="block text-xs text-slate-400 mb-1">LR Progression</label>
                                    <select id="longRunProgressionInput"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors font-mono">
                                        <option value="2.0" selected>2.0 km</option>
                                        <option value="1.5">1.5 km</option>
                                        <option value="1.0">1.0 km</option>
                                    </select>
                                </div>
                                <div id="taperContainerRun">
                                    <label class="block text-xs text-slate-400 mb-1">Taper Duration</label>
                                    <select id="taperDurationInputRun"
                                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition-colors font-mono">
                                        <option value="3" selected>3 Weeks</option>
                                        <option value="2">2 Weeks</option>
                                        <option value="1">1 Week</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Action Button (Hidden Initially) -->
                    <div id="step-5-plan-action" class="hidden">
                        <button onclick="calculateAndShowPlan()"
                            class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 rounded-lg shadow-lg shadow-green-900/20 transition-all transform hover:scale-[1.02]">
                            <i class="fa-solid fa-calendar-days mr-2"></i> Calculate & Update Weekly Plan
                        </button>
                    </div>

                    <!-- 6. AI Configuration (Always Visible but at bottom) -->
                    <div class="space-y-4 pt-4 border-t border-slate-800">
                        <div class="flex items-center gap-2 text-slate-500">
                            <i class="fa-solid fa-robot"></i>
                            <label class="text-sm font-bold uppercase tracking-wider">AI Configuration
                                (Optional)</label>
                        </div>
                        <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/30 space-y-4">
                            <div>
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">AI
                                    Provider</label>
                                <select id="aiProviderSelect" onchange="toggleProviderFields()"
                                    class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-slate-500 outline-none transition-colors">
                                    <option value="openai">OpenAI (GPT-4o)</option>
                                    <option value="gemini">Google Gemini (2.5 Pro)</option>
                                </select>
                            </div>
                            <div id="openai-field">
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">OpenAI API
                                    Key</label>
                                <input type="password" id="aiApiKeyInput"
                                    class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-slate-500 outline-none transition-colors"
                                    placeholder="sk-...">
                            </div>
                            <div id="gemini-field" class="hidden">
                                <label class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">Gemini API
                                    Key</label>
                                <input type="password" id="geminiApiKeyInput"
                                    class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-slate-500 outline-none transition-colors"
                                    placeholder="AIza...">
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <button onclick="saveSettings()"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 rounded-lg border border-slate-700 transition-colors">
                        Save Configuration & Close
                    </button>
                </div>

                <!-- Configuration Tools -->
                <div class="border-t border-slate-800 pt-6 mt-6">
                    <div class="flex items-center gap-2 text-slate-400 mb-4">
                        <i class="fa-solid fa-toolbox"></i>
                        <label class="text-xs font-bold uppercase tracking-wider">Configuration
                            Tools</label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportConfiguration()"
                            class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold py-2 rounded border border-slate-700 transition-colors">
                            <i class="fa-solid fa-download mr-1"></i> Export Config
                        </button>
                        <div class="flex gap-2">
                            <input type="text" id="importConfigInput" placeholder="Paste config string..."
                                class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 text-xs text-white focus:border-blue-500 outline-none">
                            <button onclick="importConfiguration()"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold px-3 rounded border border-slate-700 transition-colors">
                                <i class="fa-solid fa-upload"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Targets Management -->
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <button type="button" id="push-targets-btn" onclick="pushWeeklyTargetsToIntervals()"
                            class="bg-blue-900/30 hover:bg-blue-900/50 text-blue-300 text-xs font-bold py-2 rounded border border-blue-800/50 transition-colors">
                            <i class="fa-solid fa-bullseye mr-1"></i> Push Weekly Targets
                        </button>
                        <button type="button" id="delete-targets-btn" onclick="deleteFutureTargets()"
                            class="bg-red-900/30 hover:bg-red-900/50 text-red-300 text-xs font-bold py-2 rounded border border-red-800/50 transition-colors">
                            <i class="fa-solid fa-trash mr-1"></i> Delete Future Targets
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progression Calendar Side Panel (Hidden by default) -->
        <div id="progressionSidePanel"
            class="hidden w-80 bg-slate-900 border border-slate-700 rounded-xl overflow-hidden shadow-2xl flex flex-col transition-all duration-300">
            <div class="p-4 border-b border-slate-800 bg-slate-800/30 flex justify-between items-center">
                <h3 class="text-sm font-bold text-white">Progression Path</h3>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="pushWeeklyTargetsToIntervals()"
                        class="text-blue-400 hover:text-blue-300 text-xs font-bold px-2 py-1 rounded border border-blue-500/30 bg-blue-600/10 transition-colors"
                        title="Push Targets to Intervals.icu">
                        <i class="fa-solid fa-bullseye"></i>
                    </button>
                    <button type="button" onclick="toggleProgressionSidePanel(false)"
                        class="text-slate-400 hover:text-white">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            <div id="progression-calendar-content" class="flex-1 overflow-y-auto p-4 space-y-2 min-h-0">
                <!-- Injected via JS -->
            </div>
        </div>

    </div>
    </div>

    <script src="js/config.js"></script>

    <script src="js/utils.js"></script>
    <script src="js/goal-assessment.js"></script>

    <script src="js/intervals-service.js"></script>

    <script src="js/planning-running.js"></script>
    <script src="js/planning-cycling.js"></script>
    <script src="js/smart-planner.js"></script>

    <script src="js/logic.js"></script>

    <script src="js/ai-service.js"></script>

    <script src="js/progression.js"></script>

    <script src="js/weekly-ui.js"></script>
    <script src="js/ui.js"></script>

    <script src="js/main.js"></script>

</body>

</html>