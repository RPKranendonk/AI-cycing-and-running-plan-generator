<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intervals.icu API Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .week-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workout-day {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #4a9eff;
        }

        .workout-day.rest {
            border-left-color: #22c55e;
        }

        .workout-day.long-run {
            border-left-color: #f97316;
        }

        .workout-day.intervals {
            border-left-color: #ef4444;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .day-name {
            font-weight: 600;
            color: #fff;
            font-size: 1.1rem;
        }

        .workout-type {
            font-size: 0.85rem;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .workout-description {
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.5;
            white-space: pre-line;
        }

        .preview-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .preview-title {
            font-size: 0.85rem;
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .preview-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .preview-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .preview-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-value {
            color: #e0e0e0;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            white-space: pre-line;
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .push-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .push-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .push-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 87, 108, 0.4);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .config-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 0.95rem;
        }

        input::placeholder {
            color: #64748b;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Intervals.icu API Upload Test</h1>

        <div class="config-section">
            <h3 style="margin-bottom: 15px; color: #fff;">Configuration</h3>
            <div class="config-row">
                <div>
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" placeholder="Enter your Intervals.icu API key">
                </div>
                <div>
                    <label for="athleteId">Athlete ID</label>
                    <input type="text" id="athleteId" placeholder="Enter your Athlete ID">
                </div>
            </div>
        </div>

        <div class="week-container" id="week-container">
            <!-- Workouts will be inserted here -->
        </div>

        <div class="button-container">
            <button class="push-btn" onclick="pushToIntervals()">üì§ Push to Intervals</button>
            <button class="clear-btn" onclick="clearWeek()">üóëÔ∏è Clear Week</button>
        </div>

        <div class="config-section" style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px; color: #fff;">üì§ Payload Preview (What is being sent)</h3>
            <pre id="payload-preview"
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; overflow-x: auto; color: #a78bfa; font-family: 'Courier New', monospace; font-size: 0.85rem; white-space: pre-wrap;"></pre>
        </div>
        <div class="config-section" style="margin-top: 30px; border-color: #f59e0b;">
            <h3 style="margin-bottom: 15px; color: #fcd34d;">üß† Smart Block Planner (Logic-Based)</h3>
            <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                Fetches your last 28 days of history from Intervals.icu and calculates the next week's volume and long
                run
                targets based on a 10% progression rule.
            </p>
            <button class="push-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"
                onclick="calculateSmartBlock()">üìä Fetch History & Plan Next Block</button>

            <div id="smart-plan-result" style="margin-top: 20px; display: none;">
                <!-- Compact History List -->
                <div class="preview-box" style="margin-bottom: 15px;">
                    <div class="preview-label">Recent Training History</div>
                    <div id="weekly-breakdown" style="font-size: 0.9rem; line-height: 1.6; color: #cbd5e1;">
                        Loading...</div>
                </div>

                <!-- Summary Sentence -->
                <div
                    style="margin-bottom: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.9rem; color: #e0e0e0; line-height: 1.5;">
                    <span id="history-summary-text">Calculating summary...</span>
                </div>

                <!-- Recommendation Section -->
                <div
                    style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 15px;">
                    <h4 id="recommendation-title" style="color: #4ade80; margin-bottom: 10px; font-size: 1rem;">üöÄ
                        Proposed Next Block Start</h4>
                    <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                        Based on your previous weeks, we recommend the following starting targets. You can adjust them
                        below:
                    </p>

                    <!-- Rest Week Option (Hidden by default) -->
                    <div id="rest-week-suggestion"
                        style="display: none; margin-bottom: 15px; background: rgba(250, 204, 21, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(250, 204, 21, 0.3);">
                        <!-- Content injected by JS -->
                    </div>

                    <!-- Inputs -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="preview-label" style="margin-bottom: 5px; display:block;">Starting Volume
                                (km)</label>
                            <input type="number" id="target-volume"
                                style="font-size: 1.1rem; font-weight: bold; color: #fff; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); padding: 8px; width: 100%; border-radius: 4px;"
                                placeholder="0.0">
                        </div>
                        <div>
                            <label class="preview-label" style="margin-bottom: 5px; display:block;">Longest Run
                                (km)</label>
                            <input type="number" id="target-long-run"
                                style="font-size: 1.1rem; font-weight: bold; color: #fff; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); padding: 8px; width: 100%; border-radius: 4px;"
                                placeholder="0.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-section" style="margin-top: 30px; border-color: #ec4899;">
            <h3 style="margin-bottom: 15px; color: #f472b6;">üéØ Weekly Targets Test</h3>
            <p style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 15px;">
                Push weekly targets for Run (Distance) and Cycling (Load/TSS).
            </p>

            <div class="config-row">
                <div>
                    <label for="target-start-date">Target Week Start (Monday)</label>
                    <input type="date" id="target-start-date">
                </div>
            </div>
            <!-- Week 1 Inputs -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #a78bfa; margin-bottom: 10px;">Week 1</h4>
                <div class="config-row" style="margin-bottom: 0;">
                    <div>
                        <label for="run-target-dist">Run Distance (km)</label>
                        <input type="number" id="run-target-dist" placeholder="e.g. 50">
                    </div>
                    <div>
                        <label for="cycle-target-load">Cycling Load (TSS)</label>
                        <input type="number" id="cycle-target-load" placeholder="e.g. 500">
                    </div>
                </div>
            </div>

            <!-- Week 2 Inputs -->
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                <h4 id="week2-header" style="color: #f472b6; margin-bottom: 10px;">Week 2 (Starts ...)</h4>
                <div class="config-row" style="margin-bottom: 0;">
                    <div>
                        <label for="run-target-dist-w2">Run Distance (km)</label>
                        <input type="number" id="run-target-dist-w2" placeholder="e.g. 55">
                    </div>
                    <div>
                        <label for="cycle-target-load-w2">Cycling Load (TSS)</label>
                        <input type="number" id="cycle-target-load-w2" placeholder="e.g. 520">
                    </div>
                </div>
            </div>

            <div class="button-container" style="margin-top: 20px;">
                <button class="push-btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);"
                    onclick="pushTargets()">üöÄ Push Targets (Week 1 & 2)</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Pre-populated workout data for the week starting Dec 1, 2025
        const workouts = [
            {
                date: "2025-12-08",
                day: "Monday",
                type: "Recovery",
                className: "rest",
                description_ui: "Easy recovery run - 40 min",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 25m 65-75% Pace

Cooldown
- 5m 60% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 1500, intensity: "65-75% Pace" },
                    { type: "Cooldown", duration: 300, intensity: "60% Pace" }
                ]
            },
            {
                date: "2025-12-09",
                day: "Tuesday",
                type: "Endurance Run",
                className: "intervals",
                description_ui: "Steady endurance run - 70 min",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 50m 75-85% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 3000, intensity: "75-85% Pace" },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            },
            {
                date: "2025-12-10",
                day: "Wednesday",
                type: "5km + Strides",
                className: "intervals",
                description_ui: "5km run + 6x100m strides",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 5.00km 80-85% Pace

Strides
6x
- Press Lap 0.10km 95-100% Pace
- Press Lap 1m 50-65% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", distance: 5000, intensity: "80-85% Pace" },
                    { type: "Run", distance: 100, intensity: "95-100% Pace", reps: 6, recovery_duration: 60, recovery_intensity: "50% Pace", recovery_press_lap: true },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            },
            {
                date: "2025-12-11",
                day: "Friday",
                type: "VO2 Max Intervals",
                className: "intervals",
                description_ui: "4x3min VO2 Max intervals",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
4x
- 3m 100-105% Pace
- 3m 50-65% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 180, intensity: "100-105% Pace", reps: 4, recovery_duration: 180, recovery_intensity: "60% Pace" },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            },
            {
                date: "2025-12-12",
                day: "Sunday",
                type: "Long Run",
                className: "long-run",
                description_ui: "Long run - 110 min steady",
                description: `Warmup
- Press Lap 10m 60-70% Pace

Main Set
- 90m 70-80% Pace

Cooldown
- 10m 60-70% Pace`,
                steps: [
                    { type: "Warmup", duration: 600, intensity: "60-70% Pace", press_lap: true },
                    { type: "Run", duration: 5400, intensity: "70-80% Pace" },
                    { type: "Cooldown", duration: 600, intensity: "60-70% Pace" }
                ]
            }
        ];

        // Render workouts on page load
        function renderWorkouts() {
            const container = document.getElementById('week-container');
            let html = '';

            workouts.forEach(workout => {
                const formattedDesc = formatStepsForIntervals(workout.steps);
                html += `
                    <div class="workout-card">
                        <div class="workout-day ${workout.className}">
                            <div class="day-header">
                                <div class="day-name">${workout.day} (${workout.date})</div>
                                <div class="workout-type">${workout.type}</div>
                            </div>
                            <div class="workout-description">${workout.description}</div>
                        </div>
                        <div class="preview-section">
                            <div class="preview-title">üìã How this will appear in Intervals.icu</div>
                            <div class="preview-content">
                                <div class="preview-box">
                                    <div class="preview-label">Workout Title</div>
                                    <div class="preview-value">${workout.type}</div>
                                </div>
                                <div class="preview-box">
                                    <div class="preview-label">Weekly Overview Description</div>
                                    <div class="preview-value">${workout.description_ui}</div>
                                </div>
                            </div>
                            <div class="preview-box" style="margin-top: 10px;">
                                <div class="preview-label">Full Workout Description (API Format)</div>
                                <div class="preview-value">${formattedDesc}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Format steps for Intervals.icu API
        function formatStepsForIntervals(steps) {
            if (!steps || !Array.isArray(steps)) return "";

            let text = "";
            steps.forEach(step => {
                let line = "";

                if (step.type === "Warmup") line += "Warmup\n";
                if (step.type === "Cooldown") line += "Cooldown\n";
                if (step.type === "Rest") line += "Rest\n";

                let dur = "";
                if (step.duration) {
                    const mins = Math.floor(step.duration / 60);
                    const secs = step.duration % 60;
                    if (mins > 0) dur += `${mins}m`;
                    if (secs > 0) dur += `${secs}s`;
                } else if (step.distance) {
                    // Always use km to avoid Intervals.icu interpreting meters as minutes
                    dur += `${(step.distance / 1000).toFixed(2)}km`;
                }

                let intensity = step.intensity || "";
                let pressLap = step.press_lap ? "Press Lap " : "";

                if (step.reps) {
                    line += `${step.reps}x\n`;
                    line += `- ${pressLap}${dur} ${intensity}\n`;

                    if (step.recovery_duration || step.recovery_distance) {
                        let recDur = "";
                        if (step.recovery_duration) {
                            const rMins = Math.floor(step.recovery_duration / 60);
                            const rSecs = step.recovery_duration % 60;
                            if (rMins > 0) recDur += `${rMins}m`;
                            if (rSecs > 0) recDur += `${rSecs}s`;
                        } else if (step.recovery_distance) {
                            // Always use km to avoid Intervals.icu interpreting meters as minutes
                            recDur += `${(step.recovery_distance / 1000).toFixed(2)}km`;
                        }
                        let recInt = step.recovery_intensity || "50-65% Pace";
                        let recPressLap = step.recovery_press_lap ? "Press Lap " : "";
                        line += `- ${recPressLap}${recDur} ${recInt}\n`;
                    }
                } else {
                    line += `- ${pressLap}${dur} ${intensity}\n`;
                }

                text += line + "\n";
            });
            return text.trim();
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Push workouts to Intervals.icu
        async function pushToIntervals() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID');
                return;
            }

            const pushBtn = document.querySelector('.push-btn');
            pushBtn.disabled = true;
            pushBtn.textContent = '‚è≥ Pushing...';

            try {
                // First, delete existing workouts for this week
                await deleteWorkoutsForWeek(apiKey, athleteId);

                // Prepare events
                const events = generateEvents();

                // Bulk create
                const response = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/bulk?upsert=true`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(`API_KEY:${apiKey}`),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(events)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                showToast(`‚úÖ Successfully pushed ${events.length} workouts!`);
            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                pushBtn.disabled = false;
                pushBtn.textContent = 'üì§ Push to Intervals';
            }
        }

        function generateEvents() {
            return workouts.map(workout => ({
                category: "WORKOUT",
                start_date_local: `${workout.date}T00:00:00`,
                type: "Run",
                name: workout.type,
                description: formatStepsForIntervals(workout.steps),
                external_id: `test_upload_${workout.date}`
            }));
        }

        function renderPayload() {
            const events = generateEvents();
            document.getElementById('payload-preview').textContent = JSON.stringify(events, null, 2);
        }

        // Clear week from Intervals.icu
        async function clearWeek() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID');
                return;
            }

            if (!confirm('Delete all test workouts from Intervals.icu?')) {
                return;
            }

            const clearBtn = document.querySelector('.clear-btn');
            clearBtn.disabled = true;
            clearBtn.textContent = '‚è≥ Clearing...';

            try {
                await deleteWorkoutsForWeek(apiKey, athleteId);
                showToast('‚úÖ Workouts cleared successfully!');
            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                clearBtn.disabled = false;
                clearBtn.textContent = 'üóëÔ∏è Clear Week';
            }
        }

        // Delete workouts for the test week
        async function deleteWorkoutsForWeek(apiKey, athleteId) {
            const auth = btoa(`API_KEY:${apiKey}`);

            // Fetch events for the week
            const startDate = '2025-12-08';
            const endDate = '2025-12-14';

            const response = await fetch(
                `https://intervals.icu/api/v1/athlete/${athleteId}/events?oldest=${startDate}&newest=${endDate}`,
                {
                    headers: { 'Authorization': `Basic ${auth}` }
                }
            );

            if (!response.ok) {
                throw new Error(`Failed to fetch events: ${response.status}`);
            }

            const events = await response.json();

            // Filter for our test workouts
            const testWorkouts = events.filter(e =>
                e.external_id && e.external_id.startsWith('test_upload_')
            );

            // Delete each workout
            for (const event of testWorkouts) {
                await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/${event.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Basic ${auth}` }
                });
            }
        }

        // Initialize
        renderWorkouts();
        renderPayload();

        // Load saved config from localStorage if available
        const savedApiKey = localStorage.getItem('intervals_api_key');
        const savedAthleteId = localStorage.getItem('intervals_athlete_id');
        if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
        if (savedAthleteId) document.getElementById('athleteId').value = savedAthleteId;

        // Save config to localStorage when changed
        document.getElementById('apiKey').addEventListener('change', (e) => {
            localStorage.setItem('intervals_api_key', e.target.value);
        });
        document.getElementById('athleteId').addEventListener('change', (e) => {
            localStorage.setItem('intervals_athlete_id', e.target.value);
        });

        async function calculateSmartBlock() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();

            if (!apiKey || !athleteId) {
                showToast('‚ùå Please enter API Key and Athlete ID');
                return;
            }

            const resultDiv = document.getElementById('smart-plan-result');
            resultDiv.style.display = 'block';
            document.getElementById('weekly-breakdown').textContent = 'Fetching and analyzing...';

            try {
                // 1. Fetch Activities (Last 35 days to ensure we have 4 full weeks + baseline)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 35);

                const sStr = startDate.toISOString().split('T')[0];
                const eStr = endDate.toISOString().split('T')[0];
                const auth = btoa(`API_KEY:${apiKey}`);

                console.log('Fetching activities from', sStr, 'to', eStr);
                const url = `https://intervals.icu/api/v1/athlete/${athleteId}/activities?oldest=${sStr}&newest=${eStr}`;
                console.log('Request URL:', url);

                const res = await fetch(url, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                console.log('Response status:', res.status, res.statusText);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`Failed to fetch activities: ${res.status} - ${errorText}`);
                }

                const activities = await res.json();
                console.log('Fetched activities:', activities.length, 'total');

                const runActivities = activities.filter(a => a.type === 'Run');
                console.log('Run activities:', runActivities.length);

                if (runActivities.length === 0) {
                    document.getElementById('weekly-breakdown').textContent = 'No running activities found in the last 35 days.';
                    document.getElementById('target-volume').textContent = '-';
                    document.getElementById('target-long-run').textContent = '-';
                    showToast('‚ö†Ô∏è No running data found');
                    return;
                }

                // 2. Group by Week (Monday-Sunday)
                const weeks = {};
                runActivities.forEach(act => {
                    const d = new Date(act.start_date_local);
                    const weekNum = getWeekNumber(d);
                    const year = d.getFullYear();
                    const key = `${year}-W${weekNum}`;

                    if (!weeks[key]) weeks[key] = { vol: 0, longRun: 0, count: 0, weekNum: weekNum, year: year };

                    const km = (act.distance || 0) / 1000;
                    weeks[key].vol += km;
                    weeks[key].count++;
                    if (km > weeks[key].longRun) weeks[key].longRun = km;
                });

                // Sort weeks chronologically
                const sortedWeeks = Object.keys(weeks).sort().map(k => weeks[k]);
                console.log('Weeks found:', sortedWeeks.length, sortedWeeks);

                // We want the last 4 weeks. 
                // If we have more, take the last 4. If less, take what we have.
                const weeksToAnalyze = sortedWeeks.slice(-4);

                // 3. Generate Breakdown & Calculate Increases
                let breakdownHtml = '';
                let totalIncrease = 0;
                let increaseCount = 0;

                // Find Maxes (Last 4 Weeks)
                let maxVol = 0;
                let maxLR = 0;

                weeksToAnalyze.forEach((week, index) => {
                    let increaseStr = '';
                    let pctIncrease = 0;

                    // Compare with previous week
                    const weekIndexInFullList = sortedWeeks.indexOf(week);
                    if (weekIndexInFullList > 0) {
                        const prevWeek = sortedWeeks[weekIndexInFullList - 1];
                        if (prevWeek.vol > 0) {
                            pctIncrease = ((week.vol - prevWeek.vol) / prevWeek.vol) * 100;
                            increaseStr = `(${pctIncrease > 0 ? '+' : ''}${pctIncrease.toFixed(1)}%)`;

                            totalIncrease += pctIncrease;
                            increaseCount++;
                        }
                    }

                    // Update Maxes
                    if (week.vol > maxVol) maxVol = week.vol;
                    if (week.longRun > maxLR) maxLR = week.longRun;

                    // New Format: "Week XX: longest run Xkm and total volume Xkm (+X%)"
                    breakdownHtml += `<div style="margin-bottom: 4px;">Week ${week.weekNum}: Longest Run <strong>${week.longRun.toFixed(1)}km</strong> and Total Volume <strong>${week.vol.toFixed(1)}km</strong> <span style="color: ${pctIncrease > 5 ? '#facc15' : '#94a3b8'}">${increaseStr}</span></div>`;
                });

                // Display weekly breakdown
                document.getElementById('weekly-breakdown').innerHTML = breakdownHtml || "No recent running data found.";

                // 4. Average Increase & Summary Logic
                let avgIncrease = 0;
                if (increaseCount > 0) {
                    avgIncrease = totalIncrease / increaseCount;
                }

                // Summary Sentence: "Your longest run was Xkm and your biggest week was Xkm, on average you increased your volume by X% over the last 4 weeks."
                const summaryText = `Your longest run was <strong>${maxLR.toFixed(1)}km</strong> and your biggest week was <strong>${maxVol.toFixed(1)}km</strong>. On average you increased your volume by <strong>${avgIncrease.toFixed(1)}%</strong> over the last 4 weeks.`;
                document.getElementById('history-summary-text').innerHTML = summaryText;

                // 6. Determine Recommendation (Block Start)
                const proposedVol = maxVol * 1.10;
                let proposedLR = maxLR + 2.0;

                // Caps
                if (proposedLR > 34) proposedLR = 34;
                if (proposedLR > proposedVol * 0.55) proposedLR = proposedVol * 0.55; // 55% cap from logic.js

                // 7. Rest Week Logic
                let needRest = false;
                if (avgIncrease > 5) {
                    needRest = true;
                }

                const restDiv = document.getElementById('rest-week-suggestion');
                const resultHeader = document.getElementById('recommendation-title');

                // Calculate scenarios
                const aggressiveVol = (maxVol * 1.10).toFixed(1);
                const aggressiveLR = Math.min(maxLR + 2.0, 34, maxVol * 1.10 * 0.55).toFixed(1); // Apply caps

                const conservativeVol = (maxVol * 0.90).toFixed(1);
                const conservativeLR = Math.min(maxLR - 2.0, 34, maxVol * 0.90 * 0.55).toFixed(1); // Apply caps

                const lastWeek = weeksToAnalyze[weeksToAnalyze.length - 1] || { vol: 0, longRun: 0 };
                const restVol = (lastWeek.vol * 0.60).toFixed(1);
                const restLR = (lastWeek.longRun * 0.70).toFixed(1);

                if (needRest) {
                    restDiv.style.display = 'block';
                    restDiv.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            ‚ö†Ô∏è <strong>Rest Week Recommended!</strong><br>
                            <span style="font-size: 0.85rem; opacity: 0.9;">
                                Your average volume increase (${avgIncrease.toFixed(1)}%) is high (>5%). 
                                Taking a rest week allows your body to absorb the training, repair muscle damage, and prevent injury. 
                                Adaptation happens during rest, not just work!
                            </span>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                            <strong>Suggested Rest Week:</strong> ${restVol} km (LR: ${restLR} km)
                        </div>
                        <label style="display: flex; align-items: center; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px;">
                            <input type="checkbox" id="use-rest-week" style="width: auto; margin-right: 10px;">
                            <span>Start plan with this Rest Week?</span>
                        </label>
                        <div style="font-size: 0.8rem; margin-top: 5px; color: #cbd5e1;">
                            *If checked, the targets below will be set for the first <strong>build week</strong> after the rest week (Max -10%).
                        </div>
                    `;

                    // Event Listener for Checkbox
                    const checkbox = document.getElementById('use-rest-week');
                    const volInput = document.getElementById('target-volume');
                    const lrInput = document.getElementById('target-long-run');

                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            volInput.value = conservativeVol;
                            lrInput.value = conservativeLR;
                            showToast("üìâ Targets adjusted for post-rest rebuild");
                        } else {
                            volInput.value = aggressiveVol;
                            lrInput.value = aggressiveLR;
                            showToast("üìà Targets reset to aggressive progression");
                        }
                    });

                    // Default to unchecked (Aggressive)
                    volInput.value = aggressiveVol;
                    lrInput.value = aggressiveLR;

                    showToast("üõå Rest Week Recommended!");
                } else {
                    restDiv.style.display = 'none';

                    document.getElementById('target-volume').value = aggressiveVol;
                    document.getElementById('target-long-run').value = aggressiveLR;

                    showToast("‚úÖ Smart Plan Calculated!");
                }

            } catch (e) {
                console.error('Error in calculateSmartBlock:', e);
                showToast(`‚ùå Error: ${e.message}`);
                document.getElementById('weekly-breakdown').textContent = `Error: ${e.message}`;
            }
        }

        // --- Weekly Targets Logic ---

        // Set default date to next Monday and update Week 2 label
        function setDefaultTargetDate() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
            const nextMonday = new Date(today.setDate(diff + 7));
            const dateStr = nextMonday.toISOString().split('T')[0];

            const dateInput = document.getElementById('target-start-date');
            dateInput.value = dateStr;
            updateWeek2Label(dateStr);

            // Add listener
            dateInput.addEventListener('change', (e) => updateWeek2Label(e.target.value));
        }

        function updateWeek2Label(startDateStr) {
            if (!startDateStr) return;
            const d = new Date(startDateStr);
            d.setDate(d.getDate() + 7);
            const w2Str = d.toISOString().split('T')[0];
            document.getElementById('week2-header').textContent = `Week 2 (Starts ${w2Str})`;
        }

        // Call it after DOM load or just here if script is at end of body
        setDefaultTargetDate();

        async function pushTargets() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const athleteId = document.getElementById('athleteId').value.trim();
            const startDate = document.getElementById('target-start-date').value;

            // Week 1 Inputs
            const runDist = parseFloat(document.getElementById('run-target-dist').value);
            const cycleLoad = parseInt(document.getElementById('cycle-target-load').value);

            // Week 2 Inputs
            const runDistW2 = parseFloat(document.getElementById('run-target-dist-w2').value);
            const cycleLoadW2 = parseInt(document.getElementById('cycle-target-load-w2').value);

            if (!apiKey || !athleteId) return showToast('‚ùå Missing API Key or Athlete ID');
            if (!startDate) return showToast('‚ùå Missing Start Date');

            if (!runDist && !cycleLoad && !runDistW2 && !cycleLoadW2) {
                return showToast('‚ùå Please set at least one target');
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Pushing...';

            try {
                const promises = [];

                // --- Week 1 ---
                if (runDist) {
                    promises.push(createTargetPromise(apiKey, athleteId, startDate, "Run", runDist));
                }
                if (cycleLoad) {
                    promises.push(createTargetPromise(apiKey, athleteId, startDate, "Ride", cycleLoad));
                }

                // --- Week 2 ---
                if (runDistW2 || cycleLoadW2) {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + 7);
                    const startDateW2 = d.toISOString().split('T')[0];

                    if (runDistW2) {
                        promises.push(createTargetPromise(apiKey, athleteId, startDateW2, "Run", runDistW2));
                    }
                    if (cycleLoadW2) {
                        promises.push(createTargetPromise(apiKey, athleteId, startDateW2, "Ride", cycleLoadW2));
                    }
                }

                await Promise.all(promises);
                showToast('‚úÖ All Targets Pushed Successfully!');

            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function createTargetPromise(apiKey, athleteId, startDate, type, value) {
            const payload = [{
                category: "TARGET",
                start_date_local: `${startDate}T00:00:00`,
                type: type,
                name: `Weekly ${type} Target`,
                external_id: `target_${type.toLowerCase()}_${startDate}`,
            }];

            if (type === "Run") payload[0].distance_target = Math.round(value * 1000);
            if (type === "Ride") payload[0].load_target = value;

            return sendTargetPayload(apiKey, athleteId, payload, type === "Run" ? "Run" : "Cycling", false);
        }

        async function sendTargetPayload(apiKey, athleteId, payload, type, handleButton = true) {
            let btn = null;
            let originalText = "";

            if (handleButton) {
                btn = event.target;
                originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '‚è≥';
            }

            // Show preview (append if multiple)
            const currentPreview = document.getElementById('payload-preview').textContent;
            const newPreview = JSON.stringify(payload, null, 2);
            document.getElementById('payload-preview').textContent = currentPreview ? currentPreview + "\n\n" + newPreview : newPreview;

            try {
                // 1. Delete existing targets for this week to avoid "Duplicate weekly target" error
                // Calculate week start/end dates
                const startDate = payload[0].start_date_local.split('T')[0];
                const d = new Date(startDate);
                const endDate = new Date(d);
                endDate.setDate(d.getDate() + 6);
                const endDateStr = endDate.toISOString().split('T')[0];

                const auth = btoa(`API_KEY:${apiKey}`);

                // Fetch existing events
                const getRes = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events?oldest=${startDate}&newest=${endDateStr}&category=TARGET`, {
                    headers: { 'Authorization': `Basic ${auth}` }
                });

                if (getRes.ok) {
                    const existingEvents = await getRes.json();
                    // Filter for targets of the same type (Run or Ride)
                    const targetType = payload[0].type;
                    const targetsToDelete = existingEvents.filter(e => e.category === 'TARGET' && e.type === targetType);

                    if (targetsToDelete.length > 0) {
                        console.log(`Deleting ${targetsToDelete.length} existing ${type} targets for ${startDate}...`);
                        for (const t of targetsToDelete) {
                            await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/${t.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Basic ${auth}` }
                            });
                        }
                    }
                }

                // 2. Push new target
                const response = await fetch(`https://intervals.icu/api/v1/athlete/${athleteId}/events/bulk?upsert=true`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${auth}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                if (handleButton) showToast(`‚úÖ ${type} Target Pushed!`);

            } catch (error) {
                throw error; // Re-throw to be caught by caller
            } finally {
                if (handleButton && btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
        }

        // Helper for week number
        function getWeekNumber(d) {
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
        }
    </script>
</body>

</html>